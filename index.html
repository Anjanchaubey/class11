<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyndraAI | Elite Foundation Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PUTER.JS Added Here for Free AI -->
    <script src="https://js.puter.com/v2/"></script>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #059669;
            --secondary: #0d9488;
            --bg-dark: #0f172a;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            overscroll-behavior-y: contain;
            height: 100dvh;
            overflow: hidden;
        }

        /* Premium Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .mesh-gradient {
            background-color: #f0fdf4;
            background-image: 
                radial-gradient(at 0% 0%, rgba(5, 150, 105, 0.12) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(13, 148, 136, 0.12) 0px, transparent 50%);
        }

        /* Smooth View Transitions */
        .view-transition {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -12px rgba(5, 150, 105, 0.15);
        }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* Navigation Active States */
        .nav-item {
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-active {
            color: var(--primary);
            background: rgba(5, 150, 105, 0.1);
            border-right: 3px solid var(--primary);
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(5, 150, 105, 0); }
            100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0); }
        }
        .ai-glow { animation: pulse-border 2s infinite; }

        /* Quiz Specific Styles */
        .option-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .option-selected {
            border-color: #059669 !important;
            background-color: #ecfdf5 !important;
            color: #047857 !important;
            box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.1), 0 2px 4px -1px rgba(5, 150, 105, 0.06);
        }
        .option-correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
        }
        .option-wrong {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
        }

        /* Sidebar & Layout */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }
        
        /* Mobile: Sidebar Hidden (Translate -100%) */
        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }

        /* Desktop: Sidebar Fixed */
        @media (min-width: 768px) {
            #sidebar {
                transform: translateX(0) !important;
                width: 16rem; /* w-64 */
            }
            #main-content-wrapper {
                margin-left: 16rem;
            }
            .sidebar-toggle { display: none; }
        }

        /* Auth Screen */
        #auth-screen {
            z-index: 100;
        }

        /* Checkbox Style */
        .checkbox-wrapper input:checked + div {
            background-color: #059669;
            border-color: #059669;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }

        /* DARK MODE STYLES */
        body.dark-mode { background: #0F172A; color: #E5E7EB; transition: all 0.3s; }
        .dark-mode .mesh-gradient { background: #020617; }
        .dark-mode .glass-panel { background: #111827; border-color: #334155; }
        .dark-mode .bg-white { background: #111827 !important; }
        .dark-mode .bg-slate-50 { background: #1E293B !important; }
        .dark-mode .bg-slate-100 { background: #1E293B !important; }
        .dark-mode .text-slate-900 { color: #E5E7EB !important; }
        .dark-mode .text-slate-800 { color: #E5E7EB !important; }
        .dark-mode .text-slate-700 { color: #9CA3AF !important; }
        .dark-mode .text-slate-600 { color: #9CA3AF !important; }
        .dark-mode .text-slate-500 { color: #6B7280 !important; }
        .dark-mode .text-slate-400 { color: #6B7280 !important; }
        .dark-mode .border-slate-200 { border-color: #334155 !important; }
        .dark-mode .border-slate-100 { border-color: #334155 !important; }
        .dark-mode #sidebar { background: #000000; border-color: #334155; }
        .dark-mode .nav-item:hover { background: #1E293B; }
        .dark-mode .nav-active { background: rgba(99, 102, 241, 0.1); border-color: #6366F1; color: #6366F1; }
        .dark-mode .option-btn { background: #1E293B; border-color: #334155; color: #E5E7EB; }
        .dark-mode .option-selected { background: #312e81 !important; border-color: #6366F1 !important; }
        .dark-mode .chat-scroll::-webkit-scrollbar-thumb { background: #334155; }
        .dark-mode .card-hover:hover { box-shadow: 0 20px 40px -12px rgba(99, 102, 241, 0.2); }
        .dark-mode #view-chat { background: #000000 !important; }
        .dark-mode #view-chat .bg-white { background: #000000 !important; }
        .dark-mode #view-chat .border-slate-100 { border-color: #334155 !important; }
        .dark-mode #view-chat .text-slate-800 { color: #E5E7EB !important; }
        .dark-mode #view-chat .text-slate-700 { color: #E5E7EB !important; }
        .dark-mode #view-chat .bg-slate-50 { background: #1E293B !important; }
        .dark-mode #view-chat .border-slate-200 { border-color: #334155 !important; }
        .dark-mode #leaderboard-list > div:hover { background: #8B5CF6 !important; }
        .dark-mode #view-home .bg-white\/70 { background: #000000 !important; }
        .dark-mode header.md\:hidden { background: #000000 !important; border-color: #334155 !important; }
    </style>
</head>
<body class="mesh-gradient flex flex-col h-screen overflow-hidden text-slate-800">

    <!-- AUTH SCREEN (Overlay) -->
    <div id="auth-screen" class="fixed inset-0 bg-white/30 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl border border-white/50">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-emerald-600 rounded-2xl flex items-center justify-center text-white text-2xl font-bold mx-auto mb-4 shadow-lg rotate-3">
                    M
                </div>
                <h1 class="text-2xl font-black text-slate-900">Welcome to Myndra<span class="text-emerald-600">AI</span></h1>
                <p class="text-sm text-slate-500 font-medium">Your Elite Foundation Companion</p>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Email</label>
                    <input type="email" id="login-email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Password</label>
                    <input type="password" id="login-password" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    <div class="text-right">
                        <button onclick="window.forgotPassword()" class="text-xs font-bold text-emerald-600 hover:text-emerald-700">Forgot Password?</button>
                    </div>
                </div>
                <button onclick="window.handleLogin()" class="w-full py-3 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-600 transition-colors">Log In</button>
                
                <div class="relative my-4">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                    <div class="relative flex justify-center text-xs"><span class="bg-white px-2 text-slate-400 font-bold">OR</span></div>
                </div>
                
                <button onclick="window.handleAnonymousLogin()" class="w-full py-3 bg-slate-100 text-slate-700 font-bold rounded-xl border border-slate-200 hover:bg-slate-200 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    Continue as Guest
                </button>
                
                <button onclick="window.togglePhoneAuth()" class="w-full py-3 bg-emerald-50 text-emerald-700 font-bold rounded-xl border border-emerald-200 hover:bg-emerald-100 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                    Sign in with Phone
                </button>
                
                <div class="text-center text-sm text-slate-500 mt-4">
                    New here? <button onclick="window.toggleAuthMode()" class="font-bold text-emerald-600">Create Account</button>
                </div>
            </div>

            <!-- Phone Auth Form -->
            <div id="phone-form" class="hidden space-y-4">
                <button onclick="window.togglePhoneAuth()" class="text-xs font-bold text-slate-400 hover:text-slate-600 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back
                </button>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Phone Number (India)</label>
                    <div class="flex gap-2">
                        <div class="w-16 p-3 bg-slate-200 border border-slate-300 rounded-xl text-slate-600 font-bold text-center">+91</div>
                        <input type="tel" id="phone-number" placeholder="9876543210" maxlength="10" class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    </div>
                </div>
                <div id="recaptcha-container"></div>
                <button onclick="window.handlePhoneLogin()" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-700 transition-colors">Send Code</button>
                
                <div id="otp-section" class="hidden space-y-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Verification Code</label>
                        <input type="text" id="otp-code" placeholder="123456" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    </div>
                    <button onclick="window.verifyOTP()" class="w-full py-3 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-600 transition-colors">Verify Code</button>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" class="hidden space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Email</label>
                    <input type="email" id="signup-email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Password</label>
                    <input type="password" id="signup-password" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                </div>
                <button onclick="window.handleSignup()" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-700 transition-colors">Sign Up</button>
                <div class="text-center text-sm text-slate-500 mt-4">
                    Already have an account? <button onclick="window.toggleAuthMode()" class="font-bold text-emerald-600">Log In</button>
                </div>
            </div>
        </div>
    </div>

    <!-- USERNAME MODAL -->
    <div id="username-modal" class="hidden fixed inset-0 bg-black/50 z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl">
            <h2 class="text-xl font-bold mb-2">Setup Profile</h2>
            <p class="text-sm text-slate-500 mb-4">Please choose a username to continue.</p>
            <input type="text" id="new-username" placeholder="e.g. PhysicsWizard" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-emerald-500 outline-none">
            <button onclick="window.saveUsername()" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl">Get Started</button>
        </div>
    </div>

    <!-- ABOUT MODAL -->
    <div id="about-modal" class="hidden fixed inset-0 bg-black/50 z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl relative">
            <button onclick="document.getElementById('about-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-emerald-600 rounded-2xl flex items-center justify-center text-white text-3xl font-bold mx-auto mb-4 shadow-lg">
                    M
                </div>
                <h2 class="text-2xl font-black text-slate-900 mb-2">About This Website</h2>
            </div>
            <div class="space-y-4 text-center">
                <div class="bg-slate-50 p-4 rounded-xl">
                    <p class="text-sm font-bold text-slate-600 uppercase tracking-wider mb-2">Made By</p>
                    <p class="text-xl font-black text-emerald-600">ANJAN</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl">
                    <p class="text-sm font-bold text-slate-600 uppercase tracking-wider mb-2">Developed By</p>
                    <p class="text-xl font-black text-slate-900">ANJAN</p>
                </div>
                <div class="bg-emerald-50 p-4 rounded-xl">
                    <p class="text-sm font-bold text-emerald-600 uppercase tracking-wider mb-3">Contact Us</p>
                    <a href="mailto:anjanchaubey0@gmail.com" class="inline-flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition-colors shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        Email Me
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- PROFILE SETTINGS MODAL -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-black/50 z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl relative">
            <button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-xl font-bold mb-6">Profile Settings</h2>
            
            <!-- Photo Upload -->
            <div class="flex flex-col items-center mb-6">
                <div class="w-24 h-24 rounded-full bg-slate-200 border-4 border-white shadow-md overflow-hidden mb-3 relative group">
                    <img src="" id="profile-modal-avatar" class="w-full h-full object-cover">
                    <label class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer text-white text-xs font-bold">
                        Change
                        <input type="file" id="profile-upload" class="hidden" accept="image/*" onchange="window.handleImagePreview(this)">
                    </label>
                </div>
                <p class="text-xs text-slate-400">Click image to upload</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Email</label>
                    <input type="text" id="profile-email" class="w-full p-3 bg-slate-100 border border-slate-200 rounded-xl text-slate-500" disabled>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Username</label>
                    <input type="text" id="profile-username" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                
                <button onclick="window.updateProfile()" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-700 transition-colors">Save Changes</button>
                
                <button onclick="window.handleLogout()" class="w-full py-3 border border-red-200 text-red-500 font-bold rounded-xl hover:bg-red-50 transition-colors">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP LAYOUT (Hidden until Auth) -->
    <div id="app-container" class="hidden h-full flex flex-row">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-slate-200 shadow-xl md:shadow-none flex flex-col sidebar-closed md:sidebar-open">
            <!-- Sidebar Header -->
            <div class="h-16 md:h-20 flex items-center justify-between px-6 border-b border-slate-100 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-emerald-600 rounded-lg flex items-center justify-center text-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <span class="font-extrabold text-slate-900 tracking-tight">Myndra<span class="text-emerald-600">AI</span></span>
                </div>
                <button onclick="window.toggleSidebar()" class="md:hidden text-slate-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- AI Model Selection -->
            <div class="p-4 border-b border-slate-100">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">AI Model</label>
                <select id="ai-model-select" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-2 px-3 text-xs font-bold focus:ring-2 focus:ring-emerald-500 outline-none">
                    <option value="gemini-2.5-flash">‚ö° Light (Fast)</option>
                    <option value="gemini-2.5-pro">üöÄ Pro (Powerful)</option>
                </select>
            </div>

            <!-- User Info (Clickable) -->
            <div onclick="window.openProfileModal()" class="p-6 border-b border-slate-100 cursor-pointer hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-slate-200 border-2 border-white shadow-sm overflow-hidden">
                        <img src="" alt="User" id="sidebar-avatar" class="w-full h-full object-cover">
                    </div>
                    <div class="overflow-hidden">
                        <h4 class="text-sm font-bold text-slate-900 truncate" id="sidebar-username">Loading...</h4>
                        <div class="flex items-center gap-1.5 text-[10px] font-bold text-emerald-600 uppercase tracking-wider">
                            <span id="sidebar-xr">0 XR</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Links -->
            <nav class="flex-grow p-4 space-y-1 overflow-y-auto no-scrollbar">
                <div onclick="window.switchView('home')" id="nav-home" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    Home
                </div>
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-4 mb-2 mt-2">Learn</div>
                <div onclick="window.switchView('library')" id="nav-library" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    Library
                </div>
                <div onclick="window.switchView('chat')" id="nav-chat" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    AI Tutor
                </div>
                <div onclick="window.switchView('roadmap')" id="nav-roadmap" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                    Roadmap
                </div>

                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-4 mb-2 mt-6">Track</div>
                <div onclick="window.switchView('syllabus')" id="nav-syllabus" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50">
                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Syllabus Tracker
                </div>
                <div onclick="window.switchView('leaderboard')" id="nav-leaderboard" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    Leaderboard
                </div>

                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-4 mb-2 mt-6">History</div>
                <div onclick="window.switchView('chat-history')" id="nav-chat-history" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Chat History
                </div>
                <div onclick="window.switchView('quiz-history')" id="nav-quiz-history" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    Quiz History
                </div>
            </nav>

            <!-- About & Logout -->
            <div class="p-4 border-t border-slate-100 space-y-2">
                <button onclick="window.toggleDarkMode()" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors">
                    <span id="dark-mode-icon" class="text-base">üåô</span>
                    <span id="dark-mode-text">Dark Mode</span>
                </button>
                <button onclick="window.openAboutModal()" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    About
                </button>
                <button onclick="window.handleLogout()" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold text-red-500 hover:bg-red-50 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Sign Out
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <div id="main-content-wrapper" class="flex-grow flex flex-col h-full overflow-hidden transition-all duration-300 relative">
            
            <!-- Mobile Header (Visible only on mobile) -->
            <header class="md:hidden h-16 flex items-center justify-between px-4 bg-white backdrop-blur border-b border-slate-200 shrink-0 z-40">
                <button onclick="window.toggleSidebar()" class="p-2 text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <div class="flex items-center gap-3">
                    <!-- Mobile Stream Selector -->
                    <select id="mobile-stream-select" onchange="window.changeStream(this.value)" class="bg-slate-100 border-none rounded-lg py-1 px-2 text-[10px] font-bold text-slate-700 outline-none">
                        <option value="11th Essentials" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white;">‚≠ê 11th Essentials</option>
                        <option value="11th JEE">11th JEE</option>
                        <option value="12th JEE">12th JEE</option>
                        <option value="11th NEET">11th NEET</option>
                        <option value="12th NEET">12th NEET</option>
                    </select>

                    <!-- Mobile XR Btn -->
                    <button onclick="window.switchView('leaderboard')" class="flex items-center gap-1 bg-emerald-100 text-emerald-700 px-2 py-1 rounded-lg font-bold text-[10px]">
                        <span id="mobile-header-xr">0 XR</span>
                    </button>
                    <!-- Mobile Profile Trigger -->
                    <button onclick="window.openProfileModal()" class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden border border-slate-100">
                        <img src="" id="mobile-avatar" class="w-full h-full object-cover">
                    </button>
                </div>
            </header>

            <!-- Desktop Top Right Actions (Absolute Positioned or integrated into views) -->
            <div class="hidden md:flex absolute top-4 right-6 z-50 items-center gap-4">
                <!-- Desktop Stream Selector -->
                <select id="desktop-stream-select" onchange="window.changeStream(this.value)" class="bg-white/80 backdrop-blur border border-slate-200 rounded-xl py-2 px-4 text-xs font-bold text-slate-700 outline-none shadow-sm hover:border-emerald-300 transition-colors cursor-pointer">
                    <option value="11th Essentials" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white;">‚≠ê 11th Essentials</option>
                    <option value="11th JEE">11th JEE</option>
                    <option value="12th JEE">12th JEE</option>
                    <option value="11th NEET">11th NEET</option>
                    <option value="12th NEET">12th NEET</option>
                </select>

                <!-- XR Button -->
                <button onclick="window.switchView('leaderboard')" class="flex items-center gap-2 bg-white/80 backdrop-blur border border-slate-200 text-emerald-700 px-4 py-2 rounded-xl font-bold text-sm hover:bg-emerald-50 transition-all shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span id="header-xr">0 XR</span>
                </button>
                
                <!-- Profile Trigger -->
                <button onclick="window.openProfileModal()" class="w-10 h-10 rounded-full border-2 border-white shadow-md overflow-hidden bg-slate-200 transition-transform hover:scale-105 cursor-pointer">
                    <img src="" id="header-avatar" class="w-full h-full object-cover">
                </button>
            </div>

            <!-- VIEWS CONTAINER -->
            <main class="flex-grow overflow-hidden relative">
                
                <!-- HOME VIEW -->
                <section id="view-home" class="view-transition h-full overflow-y-auto custom-scroll px-4 md:px-8 py-4 md:py-8">
                    <div class="max-w-5xl mx-auto">
                        <!-- Hero Section -->
                        <div class="text-center mb-8 md:mb-12 pt-2 md:pt-8">
                            <div class="w-12 h-12 md:w-20 md:h-20 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl md:rounded-3xl flex items-center justify-center text-white text-xl md:text-3xl font-bold mx-auto mb-3 md:mb-6 shadow-2xl rotate-3 transform hover:rotate-0 transition-transform">
                                M
                            </div>
                            <h1 class="text-xl md:text-5xl font-black text-slate-900 mb-1 md:mb-3 tracking-tight">Welcome to <span class="text-emerald-600">MyndraAI</span><span class="md:hidden">, <span id="home-username-mobile">User</span>!</span></h1>
                            <p class="text-sm md:text-lg text-slate-600 font-medium hidden md:block">Your Elite Foundation Companion for <span id="home-stream-name" class="font-bold text-emerald-600">JEE & NEET</span></p>
                        </div>

                        <!-- Feature Cards Grid -->
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6 mb-8">
                            <!-- Library Card -->
                            <div onclick="window.switchView('library')" class="card-hover glass-panel p-4 md:p-8 rounded-2xl md:rounded-3xl cursor-pointer group relative overflow-hidden">
                                <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-100/50 rounded-full blur-3xl group-hover:bg-indigo-200/50 transition-colors"></div>
                                <div class="relative">
                                    <div class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-indigo-100 flex items-center justify-center text-indigo-600 mb-3 md:mb-4 group-hover:scale-110 transition-transform">
                                        <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                                    </div>
                                    <h3 class="text-base md:text-xl font-bold text-slate-900 mb-1 md:mb-2 group-hover:text-indigo-600 transition-colors">Library</h3>
                                    <p class="text-xs md:text-sm text-slate-600 hidden md:block">Browse chapters, study materials, and resources</p>
                                </div>
                            </div>

                            <!-- World Chat Card -->
                            <div onclick="window.location.href='chat.html'" class="card-hover glass-panel p-4 md:p-8 rounded-2xl md:rounded-3xl cursor-pointer group relative overflow-hidden">
                                <div class="absolute -top-10 -right-10 w-32 h-32 bg-violet-100/50 rounded-full blur-3xl group-hover:bg-violet-200/50 transition-colors"></div>
                                <div class="relative">
                                    <div class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-violet-100 flex items-center justify-center text-violet-600 mb-3 md:mb-4 group-hover:scale-110 transition-transform">
                                        <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"></path></svg>
                                    </div>
                                    <h3 class="text-base md:text-xl font-bold text-slate-900 mb-1 md:mb-2 group-hover:text-violet-600 transition-colors">World Chat</h3>
                                    <p class="text-xs md:text-sm text-slate-600 hidden md:block">Connect with fellow students</p>
                                </div>
                            </div>

                            <!-- AI Tutor Card -->
                            <div onclick="window.switchView('chat')" class="card-hover glass-panel p-4 md:p-8 rounded-2xl md:rounded-3xl cursor-pointer group relative overflow-hidden">
                                <div class="absolute -top-10 -right-10 w-32 h-32 bg-emerald-100/50 rounded-full blur-3xl group-hover:bg-emerald-200/50 transition-colors"></div>
                                <div class="relative">
                                    <div class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-emerald-100 flex items-center justify-center text-emerald-600 mb-3 md:mb-4 group-hover:scale-110 transition-transform">
                                        <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                                    </div>
                                    <h3 class="text-base md:text-xl font-bold text-slate-900 mb-1 md:mb-2 group-hover:text-emerald-600 transition-colors">AI Tutor</h3>
                                    <p class="text-xs md:text-sm text-slate-600 hidden md:block">Get instant help with your doubts and questions</p>
                                </div>
                            </div>

                            <!-- Syllabus Tracker Card -->
                            <div onclick="window.switchView('syllabus')" class="card-hover glass-panel p-4 md:p-8 rounded-2xl md:rounded-3xl cursor-pointer group relative overflow-hidden">
                                <div class="absolute -top-10 -right-10 w-32 h-32 bg-teal-100/50 rounded-full blur-3xl group-hover:bg-teal-200/50 transition-colors"></div>
                                <div class="relative">
                                    <div class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-teal-100 flex items-center justify-center text-teal-600 mb-3 md:mb-4 group-hover:scale-110 transition-transform">
                                        <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                    <h3 class="text-base md:text-xl font-bold text-slate-900 mb-1 md:mb-2 group-hover:text-teal-600 transition-colors">Syllabus Tracker</h3>
                                    <p class="text-xs md:text-sm text-slate-600 hidden md:block">Track your progress and completed chapters</p>
                                </div>
                            </div>

                            <!-- Quiz Card -->
                            <div onclick="window.switchView('library')" class="card-hover glass-panel p-4 md:p-8 rounded-2xl md:rounded-3xl cursor-pointer group relative overflow-hidden">
                                <div class="absolute -top-10 -right-10 w-32 h-32 bg-rose-100/50 rounded-full blur-3xl group-hover:bg-rose-200/50 transition-colors"></div>
                                <div class="relative">
                                    <div class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-rose-100 flex items-center justify-center text-rose-600 mb-3 md:mb-4 group-hover:scale-110 transition-transform">
                                        <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                    </div>
                                    <h3 class="text-base md:text-xl font-bold text-slate-900 mb-1 md:mb-2 group-hover:text-rose-600 transition-colors">Quiz</h3>
                                    <p class="text-xs md:text-sm text-slate-600 hidden md:block">Test your knowledge with practice questions</p>
                                </div>
                            </div>

                            <!-- Roadmap Card -->
                            <div onclick="window.switchView('roadmap')" class="card-hover glass-panel p-4 md:p-8 rounded-2xl md:rounded-3xl cursor-pointer group relative overflow-hidden">
                                <div class="absolute -top-10 -right-10 w-32 h-32 bg-purple-100/50 rounded-full blur-3xl group-hover:bg-purple-200/50 transition-colors"></div>
                                <div class="relative">
                                    <div class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-purple-100 flex items-center justify-center text-purple-600 mb-3 md:mb-4 group-hover:scale-110 transition-transform">
                                        <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                                    </div>
                                    <h3 class="text-base md:text-xl font-bold text-slate-900 mb-1 md:mb-2 group-hover:text-purple-600 transition-colors">Roadmap</h3>
                                    <p class="text-xs md:text-sm text-slate-600 hidden md:block">Generate personalized study plans</p>
                                </div>
                            </div>

                            <!-- Leaderboard Card -->
                            <div onclick="window.switchView('leaderboard')" class="card-hover glass-panel p-4 md:p-8 rounded-2xl md:rounded-3xl cursor-pointer group relative overflow-hidden">
                                <div class="absolute -top-10 -right-10 w-32 h-32 bg-amber-100/50 rounded-full blur-3xl group-hover:bg-amber-200/50 transition-colors"></div>
                                <div class="relative">
                                    <div class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-amber-100 flex items-center justify-center text-amber-600 mb-3 md:mb-4 group-hover:scale-110 transition-transform">
                                        <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                                    </div>
                                    <h3 class="text-base md:text-xl font-bold text-slate-900 mb-1 md:mb-2 group-hover:text-amber-600 transition-colors">Leaderboard</h3>
                                    <p class="text-xs md:text-sm text-slate-600 hidden md:block">See top performers and your ranking</p>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="bg-white/70 backdrop-blur rounded-3xl p-6 border border-slate-200 shadow-sm">
                            <h3 class="text-lg font-bold text-slate-900 mb-4">Your Progress</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-black text-emerald-600" id="home-xr-display">0</div>
                                    <div class="text-xs text-slate-500 font-bold uppercase">XR Points</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-black text-indigo-600" id="home-syllabus-display">0%</div>
                                    <div class="text-xs text-slate-500 font-bold uppercase">Completed</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-black text-rose-600" id="home-quiz-count">0</div>
                                    <div class="text-xs text-slate-500 font-bold uppercase">Quizzes Taken</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-black text-purple-600" id="home-chat-count">0</div>
                                    <div class="text-xs text-slate-500 font-bold uppercase">AI Chats</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- LIBRARY VIEW -->
                <section id="view-library" class="view-transition h-full overflow-y-auto custom-scroll px-4 md:px-8 py-4 md:py-8">
                    <div class="max-w-6xl mx-auto">
                        <div class="mb-8 pt-6 md:pt-0">
                            <div class="flex items-center gap-3 mb-1">
                                <h2 class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight">Library</h2>
                                <span id="current-stream-badge" class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-md uppercase">11th JEE</span>
                            </div>
                            <p class="text-slate-500">Select a module to begin.</p>
                        </div>
                        
                        <!-- Filter -->
                        <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-2" id="library-filters">
                            <!-- Injected via JS -->
                        </div>

                        <div id="chapters-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-20">
                            <!-- JS Injected -->
                        </div>
                    </div>
                </section>

                <!-- QUIZ VIEW -->
                <section id="view-quiz" class="view-transition hidden absolute inset-0 bg-slate-50 z-50 flex flex-col">
                    <div id="quiz-loading" class="flex flex-col items-center justify-center h-full">
                        <div class="w-16 h-16 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mb-6"></div>
                        <h3 class="text-xl font-bold text-slate-800">Generating Questions...</h3>
                        <p class="text-sm text-slate-500 mt-2 font-medium" id="quiz-mode-text">Targeting JEE Mains PYQs</p>
                    </div>

                    <div id="quiz-active" class="hidden flex-col h-full">
                        <div class="h-16 px-6 bg-white border-b border-slate-200 flex items-center justify-between shrink-0">
                            <span class="text-xs font-black uppercase tracking-widest text-emerald-600 bg-emerald-50 px-2 py-1 rounded">Quiz Mode</span>
                            <div class="flex items-center gap-4">
                                <span id="quiz-timer" class="font-mono font-bold text-slate-700">00:00</span>
                                <button onclick="window.quitQuiz()" class="text-sm font-bold text-slate-400 hover:text-red-500">Quit</button>
                            </div>
                        </div>
                        <div class="flex-grow overflow-y-auto p-4 md:p-8 custom-scroll">
                            <div class="max-w-3xl mx-auto">
                                <div class="flex justify-between items-center mb-6">
                                    <span id="question-counter" class="text-sm font-bold text-slate-400">Q 1/15</span>
                                    <span id="question-year" class="text-xs font-bold text-white bg-slate-800 px-3 py-1 rounded-full">2019</span>
                                </div>
                                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-100 mb-6">
                                    <h3 id="question-text" class="text-lg font-medium text-slate-800 leading-relaxed"></h3>
                                </div>
                                <div id="options-container" class="grid grid-cols-1 gap-3"></div>
                            </div>
                        </div>
                        <div class="h-20 bg-white border-t border-slate-200 flex items-center justify-between px-4 md:px-6 shrink-0">
                            <button onclick="window.prevQuestion()" class="px-4 md:px-6 py-2 rounded-xl font-bold text-sm md:text-base text-slate-500 hover:bg-slate-100">Prev</button>
                            <button onclick="window.nextQuestion()" id="btn-next" class="px-6 md:px-8 py-3 bg-emerald-600 text-white rounded-xl font-bold text-sm md:text-base shadow-lg disabled:opacity-50">Next</button>
                            <button onclick="window.submitQuiz()" id="btn-submit" class="hidden px-6 md:px-8 py-3 bg-emerald-600 text-white rounded-xl font-bold text-sm md:text-base shadow-lg">Submit</button>
                        </div>
                    </div>

                    <div id="quiz-results" class="hidden flex-col h-full overflow-y-auto bg-slate-50 p-6">
                        <div class="max-w-3xl mx-auto w-full">
                            <div class="text-center mb-10">
                                <div class="inline-block p-4 rounded-full bg-white shadow-lg mb-4">
                                    <div class="w-32 h-32 rounded-full bg-emerald-600 text-white flex items-center justify-center text-xl font-black" id="score-circle"></div>
                                </div>
                                <h2 class="text-3xl font-bold text-slate-900">Analysis</h2>
                                <button onclick="window.closeQuiz()" class="mt-4 px-6 py-2 bg-slate-900 text-white rounded-xl font-bold">Done</button>
                            </div>
                            <div id="results-list" class="space-y-6 pb-20"></div>
                        </div>
                    </div>
                </section>

                <!-- CHAT VIEW -->
                <section id="view-chat" class="view-transition hidden h-full flex flex-col bg-white">
                    <div class="p-4 border-b border-slate-100 flex items-center justify-between shrink-0 bg-white">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-emerald-500 ai-glow"></div>
                                <h3 class="font-bold text-slate-800">AI Tutor</h3>
                            </div>
                            <select id="ai-model-select-chat" class="bg-slate-50 border border-slate-200 rounded-lg py-1 px-2 text-xs font-bold focus:ring-2 focus:ring-emerald-500 outline-none">
                                <option value="gemini-2.5-flash">‚ö° Light</option>
                                <option value="gemini-2.5-pro">üöÄ Pro</option>
                            </select>
                        </div>
                        <button onclick="window.clearChat()" class="text-xs font-bold text-slate-400 hover:text-red-500">NEW CHAT</button>
                    </div>
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4 bg-white chat-scroll">
                        <div class="flex justify-start">
                            <div class="max-w-[90%] text-slate-700 text-sm">
                                Hello! Ask me anything about your syllabus.
                            </div>
                        </div>
                    </div>
                    <div id="ai-typing" class="hidden px-6 py-2 shrink-0 bg-white">
                        <div class="flex gap-1">
                            <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></div>
                            <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-75"></div>
                            <div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-150"></div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-100 bg-white">
                        <div id="image-preview-container" class="hidden max-w-3xl mx-auto mb-2">
                            <div class="relative inline-block">
                                <img id="image-preview" class="rounded-lg border border-slate-200" style="max-height: 60px;">
                                <button onclick="window.removeImagePreview()" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="relative max-w-3xl mx-auto">
                            <input type="file" id="ai-image-input" accept="image/*" class="hidden" onchange="window.handleImageUpload(this)">
                            <button onclick="document.getElementById('ai-image-input').click()" class="absolute left-3 top-1/2 -translate-y-1/2 w-7 h-7 bg-slate-200 text-slate-700 rounded-lg flex items-center justify-center hover:bg-slate-300" title="Upload image">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                            </button>
                            <input id="ai-input" type="text" placeholder="Ask your doubt or upload a question image..." class="w-full bg-slate-50 border-none rounded-2xl py-3 pl-12 pr-12 text-sm font-medium focus:ring-2 focus:ring-emerald-500">
                            <button onclick="window.handleUserQuery()" class="absolute right-2 top-2 bottom-2 w-10 bg-emerald-600 text-white rounded-xl flex items-center justify-center hover:bg-emerald-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- ROADMAP VIEW -->
                <section id="view-roadmap" class="view-transition hidden h-full overflow-y-auto p-6">
                    <div class="max-w-2xl mx-auto text-center mt-10">
                        <div class="w-20 h-20 bg-emerald-100 rounded-3xl flex items-center justify-center text-emerald-600 mx-auto mb-6">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                        </div>
                        <h2 class="text-3xl font-black text-slate-900 mb-4">Study Roadmap</h2>
                        <button onclick="window.generateRoadmap()" class="px-8 py-4 bg-emerald-600 text-white rounded-2xl font-bold shadow-xl hover:scale-105 transition-transform">Generate 30-Day Plan</button>
                    </div>
                </section>

                <!-- LEADERBOARD VIEW -->
                <section id="view-leaderboard" class="view-transition hidden h-full overflow-y-auto p-6 custom-scroll">
                    <div class="max-w-3xl mx-auto">
                        <div class="mb-8">
                            <h2 class="text-3xl font-black text-slate-900 tracking-tight">Global Leaderboard</h2>
                            <p class="text-slate-500">Top performers ranked by Execution Rank (XR).</p>
                        </div>
                        <!-- Score Explanation -->
                        <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-xl flex items-start gap-3 mb-6">
                            <svg class="w-5 h-5 text-indigo-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <p class="text-sm text-indigo-800 font-medium leading-relaxed">
                                <span class="font-bold">How XR is Calculated:</span> You earn <span class="font-bold text-emerald-600">+10 XR</span> for completing a quiz, <span class="font-bold text-emerald-600">+4 XR</span> for each correct answer, and <span class="font-bold text-red-500">-1 XR</span> for incorrect attempts.
                            </p>
                        </div>

                        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="grid grid-cols-12 gap-4 p-4 border-b border-slate-100 bg-slate-50/50 text-xs font-bold text-slate-400 uppercase tracking-wider">
                                <div class="col-span-2 text-center">Rank</div>
                                <div class="col-span-7">Student</div>
                                <div class="col-span-3 text-right">XR Points</div>
                            </div>
                            <div id="leaderboard-list" class="divide-y divide-slate-100">
                                <!-- JS Injected -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- HISTORY VIEWS -->
                <section id="view-chat-history" class="view-transition hidden h-full overflow-y-auto p-6">
                    <div class="max-w-3xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6">Chat History</h2>
                        <div id="chat-history-list" class="space-y-3">
                            <!-- Injected -->
                        </div>
                    </div>
                </section>

                <section id="view-quiz-history" class="view-transition hidden h-full overflow-y-auto p-6">
                    <div class="max-w-3xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6">Quiz History</h2>
                        <div id="quiz-history-list" class="space-y-3">
                            <!-- Injected -->
                        </div>
                    </div>
                </section>

                <!-- SYLLABUS COMPLETION VIEW -->
                <section id="view-syllabus" class="view-transition hidden h-full overflow-y-auto p-6 custom-scroll">
                    <div class="max-w-3xl mx-auto">
                        <div class="mb-8 bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-2xl font-black text-slate-900">Syllabus Completion</h2>
                                <p class="text-lg font-bold text-emerald-600"><span id="syllabus-percent">0</span>%</p>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                                <div id="syllabus-progress-bar" class="bg-emerald-500 h-full transition-all duration-500 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-2">Track your progress based on your selected stream.</p>
                        </div>
                        <div id="syllabus-list" class="space-y-3 pb-20">
                            <!-- Injected -->
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- MODULE SCRIPT: Logic for Firebase & App -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, signInAnonymously, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCYY2GQqS0tCXb7Oxw8AWXhpexq9e8VRUs",
            authDomain: "aspirehub-32863.firebaseapp.com",
            projectId: "aspirehub-32863",
            storageBucket: "aspirehub-32863.appspot.com",
            messagingSenderId: "686810111182",
            appId: "1:686810111182:web:4290b4b1b6e64934ec449f",
            measurementId: "G-KX41R0SSMY",
            databaseURL: "https://aspirehub-32863-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Use default appId if not in Canvas env
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'myndra-default';
        
        // STATE
        let currentUser = null;
        let userProfile = null;
        let currentQuizData = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let quizTimerInterval;
        let quizTimeElapsed = 0;
        let syllabusState = {};
        let tempProfileImage = null; 
        let currentStream = "11th JEE"; // Default Stream
        let confirmationResult = null;
        let chatHistory = []; // Store conversation history
        let uploadedImage = null; // Store uploaded image

        // ==========================================
        // SYLLABUS DATA
        // ==========================================

        const rawSyllabus = {
            "11th Essentials": {
                "Physics": ["Units and Dimensions", "Vectors", "Kinematics", "Newton's Laws of Motion (NLM)", "Friction", "Work, Energy and Power", "Centre of Mass", "Rotation ‚Äì Moment of Inertia (MOI) and Torque"],
                "Chemistry": ["Mole Concept ‚Äì Basic calculation of moles", "Atomic Structure ‚Äì Basics", "States of Matter ‚Äì Ideal Gas Equation", "Periodic Table & Chemical Bonding (Must for Organic Chemistry)", "Thermodynamics ‚Äì Gibbs Free Energy Formula", "Ionic Equilibrium ‚Äì Calculation of pH & Solubility", "Redox Reactions ‚Äì Balancing of reactions"],
                "Mathematics": ["Basic Logarithms", "Quadratic Equations", "Trigonometry", "Permutations & Combinations (Basics for Probability)", "Coordinate Geometry ‚Äì Straight Line & Circle (Basics)"]
            },
            "11th JEE": {
                "Physics": ["Physical World and Measurement", "Kinematics", "Laws of Motion", "Work, Energy and Power", "System of Particles and Rotational Motion", "Gravitation", "Properties of Bulk Matter", "Thermodynamics", "Kinetic Theory of Gases", "Oscillations and Waves"],
                "Chemistry": ["Some Basic Concepts of Chemistry", "Structure of Atom", "Classification of Elements and Periodicity", "Chemical Bonding and Molecular Structure", "States of Matter: Gases and Liquids", "Thermodynamics", "Equilibrium", "Redox Reactions", "Hydrogen", "S-Block Elements", "P-Block Elements", "Organic Chemistry: Principles", "Hydrocarbons", "Environmental Chemistry"],
                "Mathematics": ["Sets, Relations and Functions", "Complex Numbers and Quadratic Equations", "Matrices (Basics)", "Permutations and Combinations", "Mathematical Induction", "Binomial Theorem", "Sequences and Series", "Limits and Derivatives", "Mathematical Reasoning", "Statistics", "Probability", "Trigonometric Functions", "Coordinate Geometry", "3D Geometry (Intro)", "Linear Inequalities"]
            },
            "12th JEE": {
                "Physics": ["Electrostatics", "Current Electricity", "Magnetic Effects of Current", "EMI and Alternating Current", "Electromagnetic Waves", "Optics", "Dual Nature of Matter", "Atoms and Nuclei", "Electronic Devices", "Communication Systems"],
                "Chemistry": ["Solid State", "Solutions", "Electrochemistry", "Chemical Kinetics", "Surface Chemistry", "Isolation of Elements", "P-Block Elements (Group 15-18)", "D-Block and F-Block Elements", "Coordination Compounds", "Haloalkanes and Haloarenes", "Alcohols, Phenols and Ethers", "Aldehydes, Ketones and Carboxylic Acids", "Amines", "Biomolecules", "Polymers", "Chemistry in Everyday Life"],
                "Mathematics": ["Relations and Functions (Advanced)", "Inverse Trigonometric Functions", "Matrices and Determinants", "Continuity and Differentiability", "Applications of Derivatives", "Integrals", "Applications of Integrals", "Differential Equations", "Vectors", "3D Geometry", "Linear Programming", "Probability (Advanced)"]
            },
            "11th NEET": {
                "Physics": ["Physical World and Measurement", "Kinematics", "Laws of Motion", "Work, Energy and Power", "System of Particles and Rigid Body", "Gravitation", "Properties of Bulk Matter", "Thermodynamics", "Behaviour of Perfect Gases", "Oscillations and Waves"],
                "Chemistry": ["Some Basic Concepts of Chemistry", "Structure of Atom", "Classification of Elements", "Chemical Bonding", "States of Matter", "Thermodynamics", "Equilibrium", "Redox Reactions", "Hydrogen", "s-Block Elements", "Some p-Block Elements", "Organic Chemistry: Principles", "Hydrocarbons", "Environmental Chemistry"],
                "Biology": ["Diversity in Living World", "Structural Organisation", "Cell Structure and Function", "Plant Physiology", "Human Physiology (Digestion etc)"] 
            },
            "12th NEET": {
                "Physics": ["Electrostatics", "Current Electricity", "Magnetic Effects of Current", "EMI and Alternating Currents", "Electromagnetic Waves", "Optics", "Dual Nature of Matter", "Atoms and Nuclei", "Electronic Devices"],
                "Chemistry": ["Solid State", "Solutions", "Electrochemistry", "Chemical Kinetics", "Surface Chemistry", "Isolation of Elements", "p-Block Elements", "d- and f-Block Elements", "Coordination Compounds", "Haloalkanes and Haloarenes", "Alcohols, Phenols and Ethers", "Aldehydes, Ketones and Carboxylic Acids", "Organic Compounds Containing Nitrogen", "Biomolecules", "Polymers", "Chemistry in Everyday Life"],
                "Biology": ["Reproduction in Organisms", "Genetics and Evolution", "Biology and Human Welfare", "Biotechnology", "Ecology and Environment"]
            }
        };

        // Helper to get styling based on subject
        function getSubjectStyle(subject) {
            const styles = {
                "Physics": { color: "indigo", icon: "M13 10V3L4 14h7v7l9-11h-7z" }, // Bolt
                "Chemistry": { color: "emerald", icon: "M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.628.282a2 2 0 01-1.806 0l-.628-.282a6 6 0 00-3.86-.517l-2.387.477a2 2 0 00-1.022.547l-1.16 1.16a2 2 0 000 2.828l1.16 1.16a2 2 0 001.022.547l2.387.477a6 6 0 003.86-.517l.628-.282a2 2 0 011.806 0l.628.282a6 6 0 003.86.517l2.387-.477a2 2 0 001.022-.547l1.16-1.16a2 2 0 000-2.828l-1.16-1.16z" }, // Flask
                "Mathematics": { color: "rose", icon: "M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" }, // Calc
                "Biology": { color: "lime", icon: "M12 19l9 2-9-18-9 18 9-2zm0 0v-8" } // Leaf-like
            };
            return styles[subject] || styles["Physics"];
        }

        // Helper to flatten syllabus object into array for rendering
        function getFlattenedChapters(stream) {
            const data = rawSyllabus[stream];
            if(!data) return [];
            let flat = [];
            Object.keys(data).forEach(subject => {
                data[subject].forEach(topic => {
                    const style = getSubjectStyle(subject);
                    // Random weight assignment for UI variety
                    const weights = ["High", "Critical", "Medium"];
                    const weight = weights[Math.floor(Math.random() * weights.length)];
                    
                    flat.push({
                        subject: subject,
                        title: topic,
                        weight: weight,
                        color: style.color,
                        icon: style.icon
                    });
                });
            });
            return flat;
        }

        // ==========================================
        // LOGIC START
        // ==========================================
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                try {
                    await loadUserProfile(user.uid);
                    await loadHistories(user.uid);
                    await loadSyllabusProgress(user.uid); 
                } catch (e) {
                    console.warn("Error loading user data:", e);
                }
            } else {
                currentUser = null;
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        async function loadUserProfile(uid) {
            try {
                const userRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
                const snap = await getDoc(userRef);
                
                let xr = 0;
                try {
                    const pubRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', uid);
                    const pubSnap = await getDoc(pubRef);
                    if(pubSnap.exists()) {
                        xr = pubSnap.data().xr || 0;
                    }
                } catch(e) {}

                if (snap.exists()) {
                    userProfile = { ...snap.data(), xr: xr };
                    // Load saved stream pref if exists, else default
                    if (userProfile.preferredStream) {
                        currentStream = userProfile.preferredStream;
                        document.getElementById('desktop-stream-select').value = currentStream;
                        document.getElementById('mobile-stream-select').value = currentStream;
                    }
                    updateSidebar(userProfile);
                } else {
                    document.getElementById('username-modal').classList.remove('hidden');
                }
                
                // Initial Render - Start with Home
                window.switchView('home');
                renderChapters('All');
                window.renderSyllabus();

            } catch (e) {
                console.error("Firestore blocked/failed:", e);
                userProfile = { username: "Guest", xr: 0 };
                updateSidebar(userProfile);
                renderChapters('All');
            }
        }

        window.changeStream = async (newStream) => {
            currentStream = newStream;
            
            // Sync both selectors
            document.getElementById('desktop-stream-select').value = newStream;
            document.getElementById('mobile-stream-select').value = newStream;
            
            // Visual Update
            document.getElementById('current-stream-badge').innerText = newStream;
            
            // Save preference if logged in
            if(currentUser) {
                try {
                    const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data');
                    await setDoc(userRef, { preferredStream: newStream }, { merge: true });
                } catch(e) { console.warn("Could not save stream pref"); }
            }

            // Re-render Views
            renderChapters('All');
            window.renderSyllabus();
        };

        window.saveUsername = async () => {
            const username = document.getElementById('new-username').value.trim();
            if(!username) return alert("Please enter a username");
            
            try {
                const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data');
                await setDoc(userRef, { 
                    username: username,
                    email: currentUser.email,
                    joinedAt: serverTimestamp(),
                    preferredStream: currentStream
                });

                const pubRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', currentUser.uid);
                await setDoc(pubRef, {
                    username: username,
                    xr: 0,
                    joinedAt: serverTimestamp()
                });

            } catch (e) {
                console.warn("Could not save username to DB:", e);
            }
            
            userProfile = { username, xr: 0 };
            updateSidebar(userProfile);
            document.getElementById('username-modal').classList.add('hidden');
        };

        function updateSidebar(profile) {
            document.getElementById('sidebar-username').innerText = profile.username;
            document.getElementById('sidebar-xr').innerText = `${profile.xr || 0} XR`;
            document.getElementById('header-xr').innerText = `${profile.xr || 0} XR`;
            document.getElementById('mobile-header-xr').innerText = `${profile.xr || 0} XR`;

            const imgUrl = profile.photoBase64 || `https://api.dicebear.com/7.x/notionists/svg?seed=${profile.username}`;
            document.getElementById('sidebar-avatar').src = imgUrl;
            document.getElementById('header-avatar').src = imgUrl;
            document.getElementById('mobile-avatar').src = imgUrl;
        }

        // ==========================================
        // PROFILE MODAL LOGIC
        // ==========================================

        window.openProfileModal = () => {
            if(!userProfile) return;
            document.getElementById('profile-email').value = currentUser.email;
            document.getElementById('profile-username').value = userProfile.username;
            const imgUrl = userProfile.photoBase64 || `https://api.dicebear.com/7.x/notionists/svg?seed=${userProfile.username}`;
            document.getElementById('profile-modal-avatar').src = imgUrl;
            document.getElementById('profile-modal').classList.remove('hidden');
        }

        window.handleImagePreview = (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 100000) { 
                    alert("Image too large. Please select an image under 100KB.");
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempProfileImage = e.target.result;
                    document.getElementById('profile-modal-avatar').src = tempProfileImage;
                }
                reader.readAsDataURL(file);
            }
        }

        window.updateProfile = async () => {
            const newUsername = document.getElementById('profile-username').value.trim();
            if(!newUsername) return alert("Username cannot be empty");

            try {
                const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data');
                const updateData = { username: newUsername };
                if(tempProfileImage) updateData.photoBase64 = tempProfileImage;

                await setDoc(userRef, updateData, { merge: true });

                const pubRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', currentUser.uid);
                await setDoc(pubRef, { username: newUsername }, { merge: true });

                userProfile.username = newUsername;
                if(tempProfileImage) userProfile.photoBase64 = tempProfileImage;
                
                updateSidebar(userProfile);
                document.getElementById('profile-modal').classList.add('hidden');
                tempProfileImage = null;
                alert("Profile updated successfully!");

            } catch(e) {
                console.error("Profile update failed:", e);
                alert("Failed to update profile. Check connection.");
            }
        }

        // ==========================================
        // AUTH ACTIONS
        // ==========================================

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                alert("Login failed: " + e.message);
            }
        };

        window.handleSignup = async () => {
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                alert("Signup failed: " + e.message);
            }
        };

        window.handleLogout = () => {
            signOut(auth);
            document.getElementById('profile-modal').classList.add('hidden');
        };

        window.toggleAuthMode = () => {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            if (loginForm.classList.contains('hidden')) {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            }
        };

        window.forgotPassword = async () => {
            const email = prompt("Enter your email to reset password:");
            if(email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    alert("Password reset email sent!");
                } catch(e) {
                    alert("Error: " + e.message);
                }
            }
        }

        window.handleAnonymousLogin = async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                alert("Anonymous login failed: " + e.message);
            }
        };

        window.togglePhoneAuth = () => {
            const loginForm = document.getElementById('login-form');
            const phoneForm = document.getElementById('phone-form');
            if (phoneForm.classList.contains('hidden')) {
                loginForm.classList.add('hidden');
                phoneForm.classList.remove('hidden');
                setTimeout(() => {
                    if (!window.recaptchaVerifier) {
                        try {
                            window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                                'size': 'normal',
                                'callback': () => {},
                                'expired-callback': () => {}
                            });
                            window.recaptchaVerifier.render();
                        } catch(e) {
                            console.error('reCAPTCHA error:', e);
                        }
                    }
                }, 100);
            } else {
                phoneForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                document.getElementById('otp-section').classList.add('hidden');
            }
        };

        window.handlePhoneLogin = async () => {
            const phoneNumber = document.getElementById('phone-number').value.trim();
            if (!phoneNumber || phoneNumber.length !== 10) return alert("Please enter a valid 10-digit phone number");
            
            try {
                if (!window.recaptchaVerifier) {
                    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                        'size': 'normal',
                        'callback': () => {},
                        'expired-callback': () => {}
                    });
                    await window.recaptchaVerifier.render();
                }
                confirmationResult = await signInWithPhoneNumber(auth, '+91' + phoneNumber, window.recaptchaVerifier);
                document.getElementById('otp-section').classList.remove('hidden');
                alert("Verification code sent!");
            } catch (e) {
                alert("Phone login failed: " + e.message);
                if (window.recaptchaVerifier) {
                    window.recaptchaVerifier.clear();
                    window.recaptchaVerifier = null;
                    document.getElementById('recaptcha-container').innerHTML = '';
                }
            }
        };

        window.verifyOTP = async () => {
            const code = document.getElementById('otp-code').value;
            if (!code) return alert("Please enter the verification code");
            
            try {
                await confirmationResult.confirm(code);
            } catch (e) {
                alert("Verification failed: " + e.message);
            }
        };

        window.openAboutModal = () => {
            document.getElementById('about-modal').classList.remove('hidden');
        }

        // ==========================================
        // UI & NAVIGATION
        // ==========================================

        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('sidebar-closed');
            sb.classList.toggle('sidebar-open');
        };

        window.switchView = async (viewId) => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-active'));
            
            let navId;
            if (viewId === 'home') navId = 'nav-home';
            else if (viewId === 'chat-history') navId = 'nav-chat-history';
            else if (viewId === 'quiz-history') navId = 'nav-quiz-history';
            else if (viewId === 'syllabus') navId = 'nav-syllabus';
            else if (viewId === 'leaderboard') navId = 'nav-leaderboard';
            else navId = `nav-${viewId.includes('chat') ? 'chat' : viewId}`;
            
            const activeNav = document.getElementById(navId);
            if(activeNav) activeNav.classList.add('nav-active');

            document.querySelectorAll('section[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('sidebar-closed');
                document.getElementById('sidebar').classList.remove('sidebar-open');
            }

            if(viewId === 'home') await updateHomeStats();
            if(viewId === 'chat-history') await loadChatHistory();
            if(viewId === 'quiz-history') await loadQuizHistory();
            if(viewId === 'syllabus') await renderSyllabus(); 
            if(viewId === 'leaderboard') await loadLeaderboard();
        };

        async function updateHomeStats() {
            // Update XR
            document.getElementById('home-xr-display').innerText = userProfile?.xr || 0;
            
            // Update Stream Name
            document.getElementById('home-stream-name').innerText = currentStream;
            
            // Update Username on mobile
            const mobileUsername = document.getElementById('home-username-mobile');
            if(mobileUsername && userProfile) {
                mobileUsername.innerText = userProfile.username || 'User';
            }
            
            // Update Syllabus Progress
            const chapters = getFlattenedChapters(currentStream);
            const completed = chapters.filter(c => syllabusState[c.title] === true).length;
            const pct = chapters.length > 0 ? Math.round((completed / chapters.length) * 100) : 0;
            document.getElementById('home-syllabus-display').innerText = pct + '%';
            
            // Update Quiz Count
            if(currentUser) {
                try {
                    const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'quiz_history'));
                    const snap = await getDocs(q);
                    document.getElementById('home-quiz-count').innerText = snap.size;
                } catch(e) {
                    document.getElementById('home-quiz-count').innerText = '0';
                }
                
                // Update Chat Count
                try {
                    const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'chat_history'));
                    const snap = await getDocs(q);
                    document.getElementById('home-chat-count').innerText = snap.size;
                } catch(e) {
                    document.getElementById('home-chat-count').innerText = '0';
                }
            }
        }

        // Render Dynamic Filters based on Stream
        function renderFilters() {
            const container = document.getElementById('library-filters');
            container.innerHTML = '';
            
            const subjects = currentStream === '11th Essentials'
                ? ['All', 'Physics', 'Chemistry', 'Mathematics']
                : currentStream.includes('NEET') 
                ? ['All', 'Physics', 'Chemistry', 'Biology']
                : ['All', 'Physics', 'Chemistry', 'Mathematics'];

            subjects.forEach(sub => {
                const btn = document.createElement('button');
                btn.innerText = sub;
                btn.className = "filter-btn shrink-0 px-4 py-2 rounded-xl bg-white text-slate-600 border border-slate-200 font-bold text-sm hover:border-emerald-300 transition-all";
                btn.onclick = () => window.filterBy(sub);
                container.appendChild(btn);
            });
            // Set All as active by default styling logic in filterBy
            window.filterBy('All'); 
        }

        window.filterBy = (subject) => {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.innerText.includes(subject)) {
                    btn.className = "filter-btn shrink-0 px-4 py-2 rounded-xl bg-emerald-600 text-white font-bold text-sm shadow-md transition-all";
                } else {
                    btn.className = "filter-btn shrink-0 px-4 py-2 rounded-xl bg-white text-slate-600 border border-slate-200 font-bold text-sm hover:border-emerald-300 transition-all";
                }
            });
            renderChapters(subject);
        };

        function renderChapters(filter = 'All') {
            // Ensure filters exist
            if(document.getElementById('library-filters').children.length === 0) renderFilters();

            const grid = document.getElementById('chapters-grid');
            grid.innerHTML = '';
            
            // Get current stream chapters
            const chapters = getFlattenedChapters(currentStream);
            const filtered = filter === 'All' ? chapters : chapters.filter(c => c.subject === filter);

            if(filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-slate-400 py-10">No chapters found for ${filter} in ${currentStream}</div>`;
                return;
            }

            const isEssentials = currentStream === '11th Essentials';

            filtered.forEach((c) => {
                const card = document.createElement('div');
                card.className = `card-hover ${isEssentials ? 'bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-200' : 'glass-panel'} p-6 rounded-3xl flex flex-col justify-between h-[250px] cursor-pointer group relative overflow-hidden`;
                card.innerHTML = `
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-${isEssentials ? 'amber' : c.color}-100/50 rounded-full blur-3xl group-hover:bg-indigo-200/50 transition-colors"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-2xl ${isEssentials ? 'bg-gradient-to-br from-amber-400 to-orange-500' : 'bg-white'} shadow-sm flex items-center justify-center text-${isEssentials ? 'white' : c.color + '-600'}">
                                ${isEssentials ? '<span class="text-xl">‚≠ê</span>' : `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${c.icon}"></path></svg>`}
                            </div>
                            <span class="text-[10px] font-black uppercase tracking-wider px-2 py-1 rounded bg-${isEssentials ? 'amber' : c.color}-50 text-${isEssentials ? 'amber' : c.color}-600">${isEssentials ? 'Essential' : 'Wt: ' + c.weight}</span>
                        </div>
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">${c.subject}</h4>
                        <h3 class="text-lg font-extrabold text-slate-900 group-hover:text-${isEssentials ? 'amber' : 'emerald'}-600 transition-colors line-clamp-2">${c.title}</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-4 relative">
                        <button onclick="window.aiAction('explain', '${c.title.replace(/'/g, "\\'")}', '${c.subject}')" class="py-3 ${isEssentials ? 'bg-gradient-to-r from-amber-500 to-orange-500' : 'bg-slate-900'} text-white rounded-xl text-xs font-bold uppercase tracking-wide hover:${isEssentials ? 'from-amber-600 to-orange-600' : 'bg-emerald-600'} transition-colors">Study</button>
                        <button onclick="window.startQuiz('${c.title.replace(/'/g, "\\'")}', '${c.subject}')" class="py-3 bg-white border border-slate-200 text-slate-700 rounded-xl text-xs font-bold uppercase tracking-wide hover:border-${isEssentials ? 'amber' : 'emerald'}-600 hover:text-${isEssentials ? 'amber' : 'emerald'}-600 transition-colors">Quiz</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        window.aiAction = async (type, topic, subject) => {
            window.switchView('chat');
            const exam = currentStream.includes('NEET') ? 'NEET' : 'JEE Mains';
            const prompt = `Explain Class 11/12 "${topic}" in ${subject} specifically for ${exam}. Be thorough but use professional, intuitive language. Use LaTeX for formulas. Format with headers.`;
            appendMsg('user', `${type.toUpperCase()}: ${topic} (${exam})`);
            await callAI(prompt);
        };

        window.handleUserQuery = async () => {
            const input = document.getElementById('ai-input');
            const query = input.value.trim();
            if (!query && !uploadedImage) return;
            
            input.value = '';
            
            if (uploadedImage) {
                appendMsg('user', query || 'Solve this question', uploadedImage);
                await callAI(query || 'Analyze this image and solve the question shown. Provide a detailed step-by-step solution.', uploadedImage);
                uploadedImage = null;
                document.getElementById('image-preview-container').classList.add('hidden');
            } else {
                appendMsg('user', query);
                await callAI(query);
            }
        };

        window.handleImageUpload = (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 5000000) {
                    alert('Image too large. Please select an image under 5MB.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImage = e.target.result;
                    document.getElementById('image-preview').src = uploadedImage;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                    document.getElementById('ai-input').placeholder = 'Image uploaded! Add context or press send...';
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeImagePreview = () => {
            uploadedImage = null;
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('ai-input').placeholder = 'Ask your doubt or upload a question image...';
            document.getElementById('ai-image-input').value = '';
        };

        // Enter key to send
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('ai-input');
            if(input) {
                input.addEventListener('keypress', (e) => {
                    if(e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        window.handleUserQuery();
                    }
                });
            }
        });

        async function callAI(prompt, imageData = null) {
            const typing = document.getElementById('ai-typing');
            typing.classList.remove('hidden');
            
            try {
                const selectedModel = document.getElementById('ai-model-select-chat')?.value || 'gemini-2.5-flash';
                
                let fullPrompt = `Act as an elite tutor for ${currentStream}. Always use LaTeX for mathematics.\n\n`;
                
                if (chatHistory.length > 0) {
                    fullPrompt += "Previous conversation:\n";
                    chatHistory.slice(-10).forEach(msg => {
                        fullPrompt += `${msg.role === 'user' ? 'Student' : 'Tutor'}: ${msg.content}\n`;
                    });
                    fullPrompt += "\n";
                }
                
                fullPrompt += `Current question: ${prompt}`;
                
                const response = imageData 
                    ? await puter.ai.chat(fullPrompt, imageData, { model: selectedModel })
                    : await puter.ai.chat(fullPrompt, { model: selectedModel });
                
                const text = (typeof response === 'string' ? response : (response?.text || response?.message?.content)) || "I'm having trouble connecting to my central brain. Please try again.";
                
                chatHistory.push({ role: 'user', content: prompt });
                chatHistory.push({ role: 'ai', content: text });
                
                appendMsg('ai', text);
                
                if(currentUser) {
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'chat_history'), {
                            prompt: prompt,
                            response: text,
                            timestamp: serverTimestamp()
                        });
                    } catch (e) {
                        console.warn("Failed to save chat history:", e);
                    }
                }

            } catch (err) {
                console.error("AI Error:", err);
                appendMsg('ai', "Error connecting to MyndraAI via Puter.js. Please check your internet connection.");
            } finally {
                typing.classList.add('hidden');
                document.getElementById('ai-input').placeholder = 'Ask your doubt or upload a question image...';
            }
        }

        function appendMsg(role, content, imageData = null) {
            const container = document.getElementById('chat-messages');
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in mb-4`;
            
            const formatted = content
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold">$1</strong>')
                .replace(/\n/g, '<br>');

            if (role === 'user' && imageData) {
                wrapper.innerHTML = `<div class="max-w-[85%] bg-emerald-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md text-sm">
                    <img src="${imageData}" class="rounded-lg mb-2 max-w-full" style="max-height: 200px;">
                    ${formatted}
                </div>`;
            } else {
                wrapper.innerHTML = role === 'user' 
                    ? `<div class="max-w-[85%] bg-emerald-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md text-sm">${formatted}</div>`
                    : `<div class="max-w-full text-slate-700 text-sm leading-relaxed">${formatted}</div>`;
            }
            
            container.appendChild(wrapper);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            if (window.MathJax) MathJax.typesetPromise();
        }

        window.clearChat = () => {
            document.getElementById('chat-messages').innerHTML = '';
            chatHistory = [];
            uploadedImage = null;
            document.getElementById('ai-input').placeholder = 'Ask your doubt or upload a question image...';
            const container = document.getElementById('chat-messages');
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start';
            wrapper.innerHTML = `<div class="max-w-[90%] text-slate-700 text-sm">Ready for a new topic. Ask me anything about ${currentStream}.</div>`;
            container.appendChild(wrapper);
        };

        window.startQuiz = async (topic, subject) => {
            window.switchView('quiz');
            document.getElementById('quiz-loading').classList.remove('hidden');
            document.getElementById('quiz-active').classList.add('hidden');
            document.getElementById('quiz-results').classList.add('hidden');
            
            // LOGIC: DETERMINE EXAM TYPE BASED ON CURRENT STREAM
            const examType = currentStream.includes('NEET') ? 'NEET' : 'JEE Mains';
            document.getElementById('quiz-mode-text').innerText = `Targeting ${examType} PYQs`;
            
            const prompt = `Generate exactly 10 ${examType} Previous Year Questions (PYQs) for "${topic}" in ${subject}. Use LaTeX for math/chem formulas (wrap in $ or $$). 
            Format each question EXACTLY like this: 
            ---QUESTION--- 
            [Write the question stem here. IMPORTANT: Do NOT include the options A, B, C, D in this section.] 
            ---OPTIONS--- 
            A) [Option A text] 
            B) [Option B text] 
            C) [Option C text] 
            D) [Option D text] 
            ---CORRECT--- 
            [Index 0-3] 
            ---YEAR--- 
            [Year, e.g., ${examType} 2020] 
            ---EXPLANATION--- 
            [Short explanation]
            
            Generate all 10 questions following this format strictly. Randomize correct answer positions.`;

            try {
                const response = await puter.ai.chat(prompt, { model: 'gemini-2.5-flash' });
                
                let rawText = typeof response === 'string' ? response : (response?.text || response?.message?.content);
                
                if (!rawText) throw new Error('No text received from API');
                
                const questions = [];
                const blocks = rawText.split('---QUESTION---').slice(1);
                
                blocks.forEach(block => {
                    const qMatch = block.match(/([\s\S]*?)---OPTIONS---/);
                    const optsMatch = block.match(/---OPTIONS---([\s\S]*?)---CORRECT---/);
                    const corrMatch = block.match(/---CORRECT---\s*(\d+)/);
                    const yearMatch = block.match(/---YEAR---\s*([^\n]+)/);
                    const explMatch = block.match(/---EXPLANATION---\s*([\s\S]*?)(?=---QUESTION---|$)/);
                    
                    if (qMatch && optsMatch && corrMatch) {
                        const optLines = optsMatch[1].trim().split('\n').filter(l => l.trim());
                        const options = optLines.map(l => l.replace(/^[A-D]\)\s*/, '').trim());
                        let questionText = qMatch[1].trim().replace(/A\).*B\).*C\).*D\).*$/s, '').trim();

                        questions.push({
                            question: questionText,
                            options: options,
                            correctIndex: parseInt(corrMatch[1]),
                            year: yearMatch ? yearMatch[1].trim() : `${examType} PYQ`,
                            explanation: explMatch ? explMatch[1].trim() : 'No explanation provided.'
                        });
                    }
                });
                
                if (questions.length < 5) throw new Error('Not enough questions generated. Try again.');
                
                currentQuizData = questions.slice(0, 10);
                currentQuestionIndex = 0;
                userAnswers = {};
                currentQuizData.topic = topic;

                document.getElementById('quiz-loading').classList.add('hidden');
                document.getElementById('quiz-active').classList.remove('hidden');
                document.getElementById('quiz-active').classList.add('flex');
                
                startTimer();
                renderQuestion();

            } catch (e) {
                console.error('Quiz generation error:', e);
                alert("Quiz generation failed: " + e.message);
                window.switchView('library');
            }
        };

        function renderQuestion() {
            const q = currentQuizData[currentQuestionIndex];
            document.getElementById('question-counter').innerText = `Q ${currentQuestionIndex + 1}/${currentQuizData.length}`;
            document.getElementById('question-year').innerText = q.year;
            document.getElementById('question-text').innerHTML = q.question;
            
            const btnNext = document.getElementById('btn-next');
            const btnSubmit = document.getElementById('btn-submit');
            btnNext.classList.toggle('hidden', currentQuestionIndex === currentQuizData.length - 1);
            btnSubmit.classList.toggle('hidden', currentQuestionIndex !== currentQuizData.length - 1);

            const hasAnswer = userAnswers[currentQuestionIndex] !== undefined;
            const activeBtn = currentQuestionIndex === currentQuizData.length - 1 ? btnSubmit : btnNext;
            activeBtn.disabled = !hasAnswer;

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                const isSelected = userAnswers[currentQuestionIndex] === idx;
                btn.className = `option-btn w-full text-left p-4 rounded-xl text-sm font-medium border transition-all ${isSelected ? 'option-selected' : 'bg-slate-50 border-slate-200 hover:bg-white'}`;
                btn.innerHTML = `<span class="font-bold mr-2">${String.fromCharCode(65+idx)}.</span> ${opt}`;
                btn.onclick = () => {
                    userAnswers[currentQuestionIndex] = idx;
                    renderQuestion();
                };
                container.appendChild(btn);
            });
            if (window.MathJax) MathJax.typesetPromise();
        }

        window.nextQuestion = () => { if (currentQuestionIndex < currentQuizData.length - 1) { currentQuestionIndex++; renderQuestion(); } };
        window.prevQuestion = () => { if (currentQuestionIndex > 0) { currentQuestionIndex--; renderQuestion(); } };

        window.submitQuiz = async () => {
            clearInterval(quizTimerInterval);
            document.getElementById('quiz-active').classList.remove('flex');
            document.getElementById('quiz-active').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('quiz-results').classList.add('flex');

            let score = 0;
            let xrEarned = 10; 

            const list = document.getElementById('results-list');
            list.innerHTML = '';

            currentQuizData.forEach((q, idx) => {
                const userIdx = userAnswers[idx];
                const isCorrect = userIdx === q.correctIndex;
                if (isCorrect) {
                    score++;
                    xrEarned += 4;
                } else if (userIdx !== undefined) {
                    xrEarned -= 1;
                }
                
                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded-2xl shadow-sm border border-slate-200";
                div.innerHTML = `
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-400">Q${idx+1}</span><span class="${isCorrect?'text-green-600':'text-red-500'} font-bold">${isCorrect?'+4': userIdx !== undefined ? '-1' : '0'}</span></div>
                    <p class="mb-4 font-medium">${q.question}</p>
                    <div class="bg-emerald-50 p-3 rounded-lg text-sm text-emerald-900">${q.explanation}</div>
                `;
                list.appendChild(div);
            });
            
            document.getElementById('score-circle').innerHTML = `
                <div class="flex flex-col items-center">
                    <span>${score}/${currentQuizData.length}</span>
                    <span class="text-sm font-bold text-emerald-200">+${xrEarned} XR</span>
                </div>
            `;
            
            if (window.MathJax) MathJax.typesetPromise();

            if(currentUser) {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'quiz_history'), {
                        topic: currentQuizData.topic || 'General',
                        score: score,
                        total: currentQuizData.length,
                        xrEarned: xrEarned,
                        date: serverTimestamp()
                    });

                    const pubRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', currentUser.uid);
                    await setDoc(pubRef, { 
                        xr: increment(xrEarned),
                        username: userProfile.username || 'Anonymous', 
                    }, { merge: true });

                    if(userProfile) {
                        userProfile.xr = (userProfile.xr || 0) + xrEarned;
                        updateSidebar(userProfile);
                    }

                } catch (e) {
                    console.warn("Failed to save quiz result:", e);
                }
            }
        };

        window.loadLeaderboard = async () => {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<p class="text-slate-400 text-sm p-4 text-center">Loading rankings...</p>';
            
            try {
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), 
                    orderBy('xr', 'desc'), 
                    limit(50)
                );
                const snap = await getDocs(q);
                
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<p class="text-slate-400 text-sm p-4 text-center">No ranked students yet.</p>';
                    return;
                }

                let rank = 1;
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = currentUser && doc.id === currentUser.uid;
                    const el = document.createElement('div');
                    el.className = `grid grid-cols-12 gap-4 p-4 items-center hover:bg-slate-50 transition-colors ${isMe ? 'bg-emerald-50/50' : ''}`;
                    el.innerHTML = `
                        <div class="col-span-2 text-center font-black text-slate-400">#${rank++}</div>
                        <div class="col-span-7 flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-200 border border-white shadow-sm overflow-hidden">
                                <img src="https://api.dicebear.com/7.x/notionists/svg?seed=${d.username}">
                            </div>
                            <span class="font-bold text-sm text-slate-700 ${isMe ? 'text-emerald-700' : ''}">${d.username}</span>
                        </div>
                        <div class="col-span-3 text-right font-black text-emerald-600 text-sm">${d.xr || 0} XR</div>
                    `;
                    list.appendChild(el);
                });
            } catch (e) {
                list.innerHTML = '<p class="text-red-400 text-sm p-4 text-center">Failed to load leaderboard.</p>';
                console.warn("Leaderboard load fail:", e);
            }
        }

        window.quitQuiz = () => { if(confirm("Quit quiz?")) window.switchView('library'); };
        window.closeQuiz = () => window.switchView('library');

        function startTimer() {
            quizTimeElapsed = 0;
            clearInterval(quizTimerInterval);
            quizTimerInterval = setInterval(() => {
                quizTimeElapsed++;
                const m = Math.floor(quizTimeElapsed/60).toString().padStart(2,'0');
                const s = (quizTimeElapsed%60).toString().padStart(2,'0');
                document.getElementById('quiz-timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        async function loadHistories(uid) {}

        async function loadChatHistory() {
            const list = document.getElementById('chat-history-list');
            list.innerHTML = '<p class="text-slate-400 text-sm">Loading...</p>';
            
            try {
                const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'chat_history'), orderBy('timestamp', 'desc'), limit(20));
                const snap = await getDocs(q);
                
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<p class="text-slate-400">No chat history yet.</p>';
                    return;
                }

                snap.forEach(doc => {
                    const d = doc.data();
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 text-sm";
                    el.innerHTML = `
                        <div class="font-bold text-slate-900 mb-1 truncate">You: ${d.prompt}</div>
                        <div class="text-slate-600 line-clamp-2">${d.response}</div>
                        <div class="text-[10px] text-slate-400 mt-2 text-right">${d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleString() : 'Just now'}</div>
                    `;
                    list.appendChild(el);
                });
            } catch (e) {
                list.innerHTML = '<p class="text-red-400">Failed to load history.</p>';
            }
        }

        async function loadQuizHistory() {
            const list = document.getElementById('quiz-history-list');
            list.innerHTML = '<p class="text-slate-400 text-sm">Loading...</p>';
            
            try {
                const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'quiz_history'), orderBy('date', 'desc'), limit(20));
                const snap = await getDocs(q);
                
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<p class="text-slate-400">No quizzes taken yet.</p>';
                    return;
                }

                snap.forEach(doc => {
                    const d = doc.data();
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between";
                    el.innerHTML = `
                        <div>
                            <div class="font-bold text-slate-900">${d.topic}</div>
                            <div class="text-xs text-slate-500">${d.date ? new Date(d.date.seconds * 1000).toLocaleDateString() : 'Just now'}</div>
                        </div>
                        <div class="bg-emerald-100 text-emerald-700 font-black px-3 py-1 rounded-lg text-lg">
                            ${d.score}/${d.total}
                        </div>
                    `;
                    list.appendChild(el);
                });
            } catch (e) {
                list.innerHTML = '<p class="text-red-400">Failed to load history.</p>';
            }
        }
        
        async function loadSyllabusProgress(uid) {
            try {
                const ref = doc(db, 'artifacts', appId, 'users', uid, 'progress', 'syllabus');
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    syllabusState = snap.data();
                } else {
                    syllabusState = {};
                }
            } catch(e) {
                syllabusState = {};
            }
        }
        
        window.renderSyllabus = async () => {
            const list = document.getElementById('syllabus-list');
            list.innerHTML = '';
            
            // Re-fetch chapters based on current stream
            const currentChapters = getFlattenedChapters(currentStream);
            let completedCount = 0;
             
            currentChapters.forEach(c => {
                 const isCompleted = syllabusState[c.title] === true;
                 if(isCompleted) completedCount++;
                 
                 const item = document.createElement('div');
                 item.className = "flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-slate-100";
                 item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <label class="checkbox-wrapper relative flex items-center cursor-pointer">
                            <input type="checkbox" class="peer sr-only" ${isCompleted ? 'checked' : ''} onchange="window.toggleChapter('${c.title.replace(/'/g, "\\'")}')">
                            <div class="w-6 h-6 border-2 border-slate-300 rounded-lg peer-checked:bg-emerald-600 peer-checked:border-emerald-600 transition-all flex items-center justify-center">
                                <svg class="w-4 h-4 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                        </label>
                        <div>
                            <h4 class="font-bold text-slate-800 ${isCompleted ? 'line-through text-slate-400' : ''}">${c.title}</h4>
                            <span class="text-xs font-bold px-2 py-0.5 rounded bg-${c.color}-50 text-${c.color}-600">${c.subject}</span>
                        </div>
                    </div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                        ${c.weight} Wt.
                    </div>
                 `;
                 list.appendChild(item);
             });
             
             const pct = currentChapters.length > 0 ? Math.round((completedCount / currentChapters.length) * 100) : 0;
             document.getElementById('syllabus-progress-bar').style.width = `${pct}%`;
             document.getElementById('syllabus-percent').innerText = pct;
        };
        
        window.toggleChapter = async (title) => {
            if(!currentUser) return;
            const newState = !syllabusState[title];
            syllabusState[title] = newState;
            await window.renderSyllabus();
            try {
                const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'progress', 'syllabus');
                await setDoc(ref, { [title]: newState }, { merge: true });
            } catch(e) {
                syllabusState[title] = !newState;
                await window.renderSyllabus();
            }
        };

        window.generateRoadmap = async () => {
            window.switchView('chat');
            const p = `Create a bulleted 30-day study roadmap for ${currentStream} covering Physics, Chemistry, and ${currentStream.includes('NEET') ? 'Biology' : 'Mathematics'}.`;
            appendMsg('user', `Generate Roadmap for ${currentStream}`);
            await callAI(p);
        };

        // DARK MODE TOGGLE
        window.toggleDarkMode = () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'true' : 'false');
            document.getElementById('dark-mode-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            document.getElementById('dark-mode-text').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        };

        // Load dark mode preference on init
        if(localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            if(document.getElementById('dark-mode-icon')) {
                document.getElementById('dark-mode-icon').textContent = '‚òÄÔ∏è';
                document.getElementById('dark-mode-text').textContent = 'Light Mode';
            }
        }
    </script>
</body>
</html>
