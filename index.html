<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyndraAI | Elite Foundation Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #059669;
            --secondary: #0d9488;
            --bg-dark: #0f172a;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            overscroll-behavior-y: contain;
            height: 100dvh;
            overflow: hidden;
        }

        /* Premium Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .mesh-gradient {
            background-color: #f0fdf4;
            background-image: 
                radial-gradient(at 0% 0%, rgba(5, 150, 105, 0.12) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(13, 148, 136, 0.12) 0px, transparent 50%);
        }

        /* Smooth View Transitions */
        .view-transition {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -12px rgba(5, 150, 105, 0.15);
        }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* Navigation Active States */
        .nav-active {
            color: var(--primary);
            background: rgba(5, 150, 105, 0.1);
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(5, 150, 105, 0); }
            100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0); }
        }
        .ai-glow { animation: pulse-border 2s infinite; }

        .floating-island {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 380px;
            z-index: 100;
        }

        /* Quiz Specific Styles */
        .option-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .option-selected {
            border-color: #059669;
            background-color: #ecfdf5;
            color: #047857;
        }
        .option-correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
        }
        .option-wrong {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
        }

        @media (min-width: 768px) {
            .desktop-container {
                max-width: 1200px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body class="mesh-gradient flex flex-col h-screen overflow-hidden">

    <!-- TOP HEADER -->
    <header id="main-header" class="h-16 md:h-20 flex items-center justify-between px-4 md:px-12 z-40 shrink-0">
        <div class="flex items-center gap-3 md:gap-4">
            <div class="w-10 h-10 md:w-12 md:h-12 bg-emerald-600 rounded-xl md:rounded-2xl flex items-center justify-center text-white shadow-xl rotate-3 hover:rotate-0 transition-transform cursor-pointer">
                <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <div>
                <h1 class="text-lg md:text-xl font-extrabold tracking-tight text-slate-900 leading-none">Myndra<span class="text-emerald-600">AI</span></h1>
                <p class="text-[10px] md:text-[11px] font-bold text-slate-400 uppercase tracking-widest mt-0.5 md:mt-1">Foundation 11</p>
            </div>
        </div>

        <div class="hidden md:flex items-center gap-8">
            <nav class="flex items-center gap-1 bg-white/50 p-1.5 rounded-2xl border border-slate-200/60">
                <button onclick="switchView('library')" id="pc-nav-library" class="px-6 py-2 rounded-xl text-sm font-bold nav-active transition-all">Library</button>
                <button onclick="switchView('roadmap')" id="pc-nav-roadmap" class="px-6 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-emerald-600 transition-all">Roadmap</button>
                <button onclick="switchView('chat')" id="pc-nav-chat" class="px-6 py-2 rounded-xl text-sm font-bold text-slate-500 hover:text-emerald-600 transition-all">AI Tutor</button>
            </nav>
        </div>

        <div class="flex items-center gap-3 md:gap-4">
            <button onclick="switchView('chat')" class="md:hidden w-9 h-9 md:w-10 md:h-10 rounded-full glass-panel flex items-center justify-center text-emerald-600 shadow-sm">
                <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
            </button>
            <div class="w-9 h-9 md:w-10 md:h-10 rounded-full border-2 border-white shadow-sm overflow-hidden bg-slate-200">
                <img src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix" alt="User">
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-grow overflow-hidden relative pb-28 md:pb-0">
        
        <!-- LIBRARY VIEW -->
        <section id="view-library" class="view-transition h-full overflow-y-auto no-scrollbar px-4 md:px-6 py-2 md:py-4">
            <div class="desktop-container">
                <div class="mb-6 md:mb-10 mt-2 md:mt-4">
                    <h2 class="text-2xl md:text-4xl font-black text-slate-900 tracking-tight mb-1 md:mb-2">Build Your <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-600">Foundation</span></h2>
                    <p class="text-xs md:text-base text-slate-500 font-medium">Select a chapter to start your deep-learning session.</p>
                </div>

                <!-- Subjects Filter -->
                <div class="flex gap-2 md:gap-3 overflow-x-auto no-scrollbar mb-6 md:mb-8 pb-2">
                    <button onclick="filterBy('All')" class="filter-btn shrink-0 px-4 py-2 md:px-6 md:py-3 rounded-xl md:rounded-2xl bg-emerald-600 text-white font-bold text-xs md:text-sm shadow-lg shadow-emerald-100 transition-all">All Subjects</button>
                    <button onclick="filterBy('Physics')" class="filter-btn shrink-0 px-4 py-2 md:px-6 md:py-3 rounded-xl md:rounded-2xl bg-white text-slate-600 border border-slate-200 font-bold text-xs md:text-sm hover:border-emerald-300 transition-all">Physics</button>
                    <button onclick="filterBy('Chemistry')" class="filter-btn shrink-0 px-4 py-2 md:px-6 md:py-3 rounded-xl md:rounded-2xl bg-white text-slate-600 border border-slate-200 font-bold text-xs md:text-sm hover:border-emerald-300 transition-all">Chemistry</button>
                    <button onclick="filterBy('Mathematics')" class="filter-btn shrink-0 px-4 py-2 md:px-6 md:py-3 rounded-xl md:rounded-2xl bg-white text-slate-600 border border-slate-200 font-bold text-xs md:text-sm hover:border-emerald-300 transition-all">Maths</button>
                </div>

                <!-- Dynamic Grid -->
                <div id="chapters-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-20">
                    <!-- Chapters injected via JS -->
                </div>
            </div>
        </section>

        <!-- QUIZ VIEW (New Dedicated Interface) -->
        <section id="view-quiz" class="view-transition hidden absolute inset-0 bg-slate-50 z-50 flex flex-col">
            <!-- Loading State -->
            <div id="quiz-loading" class="flex flex-col items-center justify-center h-full">
                <div class="w-16 h-16 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mb-6"></div>
                <h3 class="text-xl font-bold text-slate-800">Generating JEE Mains PYQs...</h3>
                <p class="text-sm text-slate-500 mt-2">Curating 15 high-yield questions from previous years.</p>
            </div>

            <!-- Active Quiz Interface -->
            <div id="quiz-active" class="hidden flex-col h-full">
                <!-- Quiz Header -->
                <div class="h-16 px-6 bg-white border-b border-slate-200 flex items-center justify-between shrink-0">
                    <div>
                        <span class="text-[10px] font-black uppercase tracking-widest text-emerald-600 bg-emerald-50 px-2 py-1 rounded">JEE Mains Mode</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="quiz-timer" class="font-mono font-bold text-slate-700">00:00</span>
                        <button onclick="quitQuiz()" class="text-sm font-bold text-slate-400 hover:text-red-500">Quit</button>
                    </div>
                </div>

                <!-- Question Area -->
                <div class="flex-grow overflow-y-auto p-4 md:p-8 custom-scroll">
                    <div class="max-w-3xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <span id="question-counter" class="text-sm font-bold text-slate-400">Question 1/15</span>
                            <span id="question-year" class="text-xs font-bold text-white bg-slate-800 px-3 py-1 rounded-full">JEE Mains 2019</span>
                        </div>
                        
                        <div class="bg-white p-6 md:p-10 rounded-3xl shadow-sm border border-slate-100 mb-8">
                            <h3 id="question-text" class="text-lg md:text-xl font-medium text-slate-800 leading-relaxed">
                                <!-- Question renders here -->
                            </h3>
                        </div>

                        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Options render here -->
                        </div>
                    </div>
                </div>

                <!-- Quiz Footer -->
                <div class="h-20 bg-white border-t border-slate-200 flex items-center justify-between px-6 md:px-12 shrink-0">
                    <button onclick="prevQuestion()" class="px-6 py-2 rounded-xl font-bold text-slate-500 hover:bg-slate-100">Previous</button>
                    <button onclick="nextQuestion()" id="btn-next" class="px-8 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 hover:scale-105 transition-transform">Next</button>
                    <button onclick="submitQuiz()" id="btn-submit" class="hidden px-8 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 hover:scale-105 transition-transform">Submit Exam</button>
                </div>
            </div>

            <!-- Quiz Results -->
            <div id="quiz-results" class="hidden flex-col h-full overflow-y-auto bg-slate-50 p-6">
                <div class="max-w-3xl mx-auto w-full">
                    <div class="text-center mb-10">
                        <div class="inline-block p-4 rounded-full bg-white shadow-lg mb-4">
                            <div class="w-24 h-24 rounded-full bg-emerald-600 text-white flex items-center justify-center text-3xl font-black" id="score-circle">
                                <!-- Score -->
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold text-slate-900">Exam Analysis</h2>
                        <p class="text-slate-500">Review your answers and explanations below.</p>
                        <button onclick="closeQuiz()" class="mt-6 px-8 py-3 bg-slate-900 text-white rounded-xl font-bold">Return to Library</button>
                    </div>

                    <div id="results-list" class="space-y-6 pb-20">
                        <!-- Review items render here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- AI CHAT VIEW -->
        <section id="view-chat" class="view-transition hidden h-full flex flex-col md:max-w-4xl md:mx-auto md:border-x md:border-slate-100 bg-white md:shadow-2xl md:rounded-t-[3rem]">
            <div class="p-4 md:p-6 border-b border-slate-50 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3 md:gap-4">
                    <button onclick="switchView('library')" class="md:hidden p-1 text-slate-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div class="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-emerald-500 ai-glow"></div>
                    <h3 class="font-extrabold text-sm md:text-base text-slate-800 tracking-tight">AI Academic Tutor</h3>
                </div>
                <button onclick="clearChat()" class="text-[10px] md:text-xs font-black uppercase tracking-widest text-slate-400 hover:text-red-500">Reset</button>
            </div>

            <div id="chat-messages" class="flex-grow overflow-y-auto p-4 md:p-6 space-y-4 md:space-y-8 chat-scroll bg-slate-50/30">
                <div class="flex justify-start">
                    <div class="max-w-[95%] md:max-w-[90%] glass-panel p-4 md:p-6 rounded-2xl md:rounded-3xl rounded-tl-none shadow-sm text-xs md:text-sm text-slate-700 leading-relaxed">
                        Welcome to **MyndraAI**. I can help you master Class 11 concepts with interactive explanations, problem-solving, and custom quizzes. 
                        <br><br>
                        Ask me anything, like: <span class="text-emerald-600 font-bold italic underline cursor-pointer" onclick="aiAction('explain', 'Laws of Motion', 'Physics')">"Explain Laws of Motion"</span>
                    </div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="ai-typing" class="hidden px-6 md:px-8 py-2 md:py-3 shrink-0">
                <div class="flex gap-1.5 items-center">
                    <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce"></div>
                    <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                    <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                </div>
            </div>

            <div class="p-4 md:p-6 bg-white border-t border-slate-100 shrink-0">
                <div class="relative max-w-2xl mx-auto">
                    <input id="ai-input" type="text" placeholder="Type your doubt here..." 
                           class="w-full bg-slate-50 border-none rounded-xl md:rounded-2xl py-3 md:py-5 pl-4 md:pl-6 pr-14 md:pr-16 text-xs md:text-sm font-medium focus:ring-2 focus:ring-emerald-500 transition-all shadow-inner">
                    <button onclick="handleUserQuery()" class="absolute right-1.5 top-1.5 bottom-1.5 md:right-2 md:top-2 md:bottom-2 w-10 md:w-12 bg-emerald-600 text-white rounded-lg md:rounded-xl shadow-lg flex items-center justify-center hover:bg-emerald-700 active:scale-95 transition-all">
                        <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </div>
            </div>
        </section>

        <!-- ROADMAP VIEW -->
        <section id="view-roadmap" class="view-transition hidden h-full overflow-y-auto px-4 md:px-6 py-6 md:py-10">
            <div class="desktop-container text-center max-w-2xl">
                <div class="w-16 h-16 md:w-20 md:h-20 bg-emerald-100 rounded-2xl md:rounded-3xl flex items-center justify-center text-emerald-600 mx-auto mb-4 md:mb-6 shadow-xl shadow-emerald-100">
                    <svg class="w-8 h-8 md:w-10 md:h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                </div>
                <h2 class="text-xl md:text-3xl font-black text-slate-900 mb-2 md:mb-4">Precision Study Roadmaps</h2>
                <p class="text-xs md:text-base text-slate-500 mb-6 md:mb-10 leading-relaxed">Let AI build you a personalized, 30-day mastery plan based on your current progress and target exams.</p>
                <button onclick="generateRoadmap()" class="w-full py-3 md:py-5 bg-emerald-600 text-white rounded-xl md:rounded-3xl font-black text-xs md:text-base uppercase tracking-widest shadow-2xl shadow-emerald-200 hover:scale-105 active:scale-95 transition-all">
                    Generate Smart Roadmap
                </button>
            </div>
        </section>

    </main>

    <!-- MOBILE FLOATING NAV -->
    <div id="nav-bar" class="md:hidden floating-island glass-panel rounded-2xl h-14 shadow-2xl flex items-center justify-around px-2">
        <button onclick="switchView('library')" id="m-nav-library" class="p-2 rounded-xl nav-active text-emerald-600 flex flex-col items-center">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
        <button onclick="switchView('roadmap')" id="m-nav-roadmap" class="p-2 rounded-xl text-slate-400 flex flex-col items-center">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
        </button>
        <button onclick="switchView('chat')" id="m-nav-chat" class="p-2 rounded-xl text-slate-400 flex flex-col items-center">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
        </button>
    </div>

    <!-- FOOTER -->
    <footer class="hidden md:block fixed bottom-0 left-0 right-0 py-2 text-center text-xs text-slate-400 bg-transparent pointer-events-none z-50">
        <p>Made by <span class="font-semibold text-slate-600">Anjan</span></p>
    </footer>

    <script>
        const apiKey = "AIzaSyDRmwN2yIi1Y2X4BXAK3pXXlIUgWOc-syI"; 
        const modelName = "gemini-2.5-flash-preview-09-2025";

        const chapters = [
            // PHYSICS
            { subject: 'Physics', title: 'Units & Dimensions', weight: 'High', color: 'indigo', icon: 'M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12' },
            { subject: 'Physics', title: 'Vectors', weight: 'Critical', color: 'indigo', icon: 'M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4' },
            { subject: 'Physics', title: 'Kinematics', weight: 'Critical', color: 'indigo', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
            { subject: 'Physics', title: 'Newton’s Laws (NLM)', weight: 'Critical', color: 'indigo', icon: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' },
            { subject: 'Physics', title: 'Friction', weight: 'High', color: 'indigo', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2' },
            { subject: 'Physics', title: 'Work, Energy, Power', weight: 'High', color: 'indigo', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
            { subject: 'Physics', title: 'Centre of Mass', weight: 'High', color: 'indigo', icon: 'M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3' },
            { subject: 'Physics', title: 'Rotation (MOI)', weight: 'Critical', color: 'indigo', icon: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' },

            // CHEMISTRY
            { subject: 'Chemistry', title: 'Mole Concept', weight: 'Critical', color: 'emerald', icon: 'M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.628.282a2 2 0 01-1.806 0l-.628-.282a6 6 0 00-3.86-.517l-2.387.477a2 2 0 00-1.022.547l-1.16 1.16a2 2 0 000 2.828l1.16 1.16a2 2 0 001.022.547l2.387.477a6 6 0 003.86-.517l.628-.282a2 2 0 011.806 0l.628.282a6 6 0 003.86.517l2.387-.477a2 2 0 001.022-.547l1.16-1.16a2 2 0 000-2.828l-1.16-1.16z' },
            { subject: 'Chemistry', title: 'Atomic Structure', weight: 'High', color: 'emerald', icon: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' },
            { subject: 'Chemistry', title: 'States of Matter', weight: 'Medium', color: 'emerald', icon: 'M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.628.282a2 2 0 01-1.806 0l-.628-.282a6 6 0 00-3.86-.517l-2.387.477a2 2 0 00-1.022.547l-1.16 1.16a2 2 0 000 2.828l1.16 1.16a2 2 0 001.022.547l2.387.477a6 6 0 003.86-.517l.628-.282a2 2 0 011.806 0l.628.282a6 6 0 003.86.517l2.387-.477a2 2 0 001.022-.547l1.16-1.16a2 2 0 000-2.828l-1.16-1.16z' },
            { subject: 'Chemistry', title: 'Periodic Table & Bonding', weight: 'Critical', color: 'emerald', icon: 'M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z' },
            { subject: 'Chemistry', title: 'Thermodynamics', weight: 'High', color: 'emerald', icon: 'M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z' },
            { subject: 'Chemistry', title: 'Ionic Equilibrium', weight: 'High', color: 'emerald', icon: 'M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z' },
            { subject: 'Chemistry', title: 'Redox Reactions', weight: 'Medium', color: 'emerald', icon: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' },

            // MATHEMATICS
            { subject: 'Mathematics', title: 'Basic Logarithms', weight: 'Medium', color: 'rose', icon: 'M7 20l4-16m2 16l4-16M6 9h14M4 15h14' },
            { subject: 'Mathematics', title: 'Quadratic Equations', weight: 'High', color: 'rose', icon: 'M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' },
            { subject: 'Mathematics', title: 'Trigonometry', weight: 'Critical', color: 'rose', icon: 'M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z' },
            { subject: 'Mathematics', title: 'Permutations (P&C)', weight: 'High', color: 'rose', icon: 'M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z' },
            { subject: 'Mathematics', title: 'Coordinate Geometry', weight: 'Critical', color: 'rose', icon: 'M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z' }
        ];

        // Quiz State
        let currentQuizData = [];
        let currentQuestionIndex = 0;
        let userAnswers = {}; // Map of questionIndex -> optionIndex

        function switchView(viewId) {
            // Hide all views
            ['library', 'chat', 'roadmap', 'quiz'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
            });
            // Show target
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            // Handle Nav
            const navBar = document.getElementById('nav-bar');
            const mainHeader = document.getElementById('main-header');
            
            if (viewId === 'quiz') {
                navBar.classList.add('hidden'); // Hide Nav in Quiz Mode
                mainHeader.classList.add('hidden'); // Hide Header in Quiz Mode
            } else {
                navBar.classList.remove('hidden');
                mainHeader.classList.remove('hidden');
                
                // Normal Nav Styling
                const navs = ['library', 'chat', 'roadmap'];
                navs.forEach(n => {
                    const pcBtn = document.getElementById(`pc-nav-${n}`);
                    const mBtn = document.getElementById(`m-nav-${n}`);
                    if (n === viewId) {
                        pcBtn?.classList.add('nav-active');
                        pcBtn?.classList.remove('text-slate-500');
                        mBtn?.classList.add('nav-active', 'text-emerald-600');
                        mBtn?.classList.remove('text-slate-400');
                    } else {
                        pcBtn?.classList.remove('nav-active');
                        pcBtn?.classList.add('text-slate-500');
                        mBtn?.classList.remove('nav-active', 'text-emerald-600');
                        mBtn?.classList.add('text-slate-400');
                    }
                });
            }
        }

        function filterBy(subject) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.className = "filter-btn shrink-0 px-4 py-2 md:px-6 md:py-3 rounded-xl md:rounded-2xl bg-white text-slate-600 border border-slate-200 font-bold text-xs md:text-sm hover:border-emerald-300 transition-all";
                if (btn.innerText.includes(subject)) {
                    btn.className = "filter-btn shrink-0 px-4 py-2 md:px-6 md:py-3 rounded-xl md:rounded-2xl bg-emerald-600 text-white font-bold text-xs md:text-sm shadow-lg shadow-emerald-100 transition-all";
                }
            });
            renderChapters(subject);
        }

        function renderChapters(filter = 'All') {
            const grid = document.getElementById('chapters-grid');
            grid.innerHTML = '';
            const filtered = filter === 'All' ? chapters : chapters.filter(c => c.subject === filter);

            filtered.forEach((c) => {
                const card = document.createElement('div');
                card.className = "card-hover glass-panel p-5 md:p-8 rounded-2xl md:rounded-[2.5rem] flex flex-col justify-between h-auto md:h-[300px] cursor-pointer group relative overflow-hidden";
                card.innerHTML = `
                    <div class="absolute -top-10 -right-10 w-24 h-24 md:w-40 md:h-40 bg-${c.color}-100/50 rounded-full blur-3xl group-hover:bg-indigo-200/50 transition-colors"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-3 md:mb-6">
                            <div class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-white shadow-sm flex items-center justify-center text-${c.color}-600">
                                <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${c.icon}"></path></svg>
                            </div>
                            <span class="text-[9px] md:text-[10px] font-black uppercase tracking-[0.2em] px-2 py-1 md:px-3 md:py-1.5 rounded-lg bg-${c.color}-50 text-${c.color}-600 border border-${c.color}-100">Wt: ${c.weight}</span>
                        </div>
                        <h4 class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-widest mb-0.5 md:mb-1">${c.subject}</h4>
                        <h3 class="text-lg md:text-2xl font-extrabold text-slate-900 leading-tight group-hover:text-emerald-600 transition-colors">${c.title}</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-2 md:gap-3 relative mt-4 md:mt-6">
                        <button onclick="aiAction('explain', '${c.title}', '${c.subject}')" class="py-2.5 md:py-3.5 px-3 md:px-4 bg-slate-900 text-white rounded-xl md:rounded-2xl text-[9px] md:text-[10px] font-black uppercase tracking-widest hover:bg-emerald-600 transition-colors">Explain</button>
                        <button onclick="startQuiz('${c.title}', '${c.subject}')" class="py-2.5 md:py-3.5 px-3 md:px-4 bg-white border border-slate-200 text-slate-700 rounded-xl md:rounded-2xl text-[9px] md:text-[10px] font-black uppercase tracking-widest hover:border-emerald-600 hover:text-emerald-600 transition-colors">JEE Quiz</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function aiAction(type, topic, subject) {
            switchView('chat');
            const prompt = `Explain Class 11 "${topic}" in ${subject}. Be thorough but use professional, intuitive language. Use LaTeX for formulas. Format with headers.`;
            appendMsg('user', `${type.toUpperCase()}: ${topic}`);
            await callAI(prompt);
        }

        async function handleUserQuery() {
            const input = document.getElementById('ai-input');
            const query = input.value.trim();
            if (!query) return;
            input.value = '';
            appendMsg('user', query);
            await callAI(query);
        }

        async function callAI(prompt) {
            const typing = document.getElementById('ai-typing');
            typing.classList.remove('hidden');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "You are an elite tutor for Class 11. Always use LaTeX for mathematics." }] }
                    })
                });
                
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm having trouble connecting to my central brain. Please try again.";
                appendMsg('ai', text);
            } catch (err) {
                appendMsg('ai', "Error connecting to MyndraAI. Please check your internet.");
            } finally {
                typing.classList.add('hidden');
            }
        }

        function appendMsg(role, content) {
            const container = document.getElementById('chat-messages');
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in mb-4 md:mb-6`;
            
            const formatted = content
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-slate-900">$1</strong>')
                .replace(/\n/g, '<br>');

            wrapper.innerHTML = role === 'user' 
                ? `<div class="max-w-[85%] bg-emerald-600 text-white p-4 md:p-5 rounded-2xl md:rounded-[2rem] rounded-tr-none shadow-lg text-xs md:text-sm font-medium">${formatted}</div>`
                : `<div class="max-w-[95%] md:max-w-[90%] glass-panel p-4 md:p-6 rounded-2xl md:rounded-[2rem] rounded-tl-none shadow-sm text-xs md:text-sm text-slate-700 leading-relaxed border border-slate-100">${formatted}</div>`;
            
            container.appendChild(wrapper);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            if (window.MathJax) MathJax.typesetPromise();
        }

        // ==========================================
        // QUIZ LOGIC
        // ==========================================

        async function startQuiz(topic, subject) {
            switchView('quiz');
            document.getElementById('quiz-loading').classList.remove('hidden');
            document.getElementById('quiz-active').classList.add('hidden');
            document.getElementById('quiz-results').classList.add('hidden');
            
            // Generate Quiz Prompt
            const prompt = `Generate a valid JSON object containing exactly 15 JEE Mains Previous Year Questions (PYQ) for the topic "${topic}" in ${subject}.
            
            Strictly follow this JSON schema:
            {
              "questions": [
                {
                  "question": "Question text using LaTeX for math...",
                  "options": ["Option A", "Option B", "Option C", "Option D"],
                  "correctIndex": 0,
                  "year": "JEE Mains 2019 (Jan)",
                  "explanation": "Detailed explanation of the solution..."
                }
              ]
            }
            Do not include markdown code blocks. Output raw JSON only. Ensure LaTeX is valid.`;

            let data;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                data = await response.json();
                let jsonText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) throw new Error('No response from AI');
                
                // Clean up markdown and fix common JSON issues
                jsonText = jsonText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                
                // Parse Quiz Data
                const parsed = JSON.parse(jsonText);
                
                if (!parsed.questions || parsed.questions.length === 0) {
                    throw new Error('No questions generated');
                }
                
                currentQuizData = parsed.questions;
                currentQuestionIndex = 0;
                userAnswers = {};

                // UI Setup
                document.getElementById('quiz-loading').classList.add('hidden');
                document.getElementById('quiz-active').classList.remove('hidden');
                document.getElementById('quiz-active').classList.add('flex');
                
                renderQuestion();

            } catch (e) {
                console.error('Quiz generation error:', e);
                if (data) console.error('Response text:', data.candidates?.[0]?.content?.parts?.[0]?.text);
                alert(`Failed to generate quiz: ${e.message}. Please try again.`);
                switchView('library');
            }
        }

        function renderQuestion() {
            const q = currentQuizData[currentQuestionIndex];
            
            document.getElementById('question-counter').innerText = `Question ${currentQuestionIndex + 1}/${currentQuizData.length}`;
            document.getElementById('question-year').innerText = q.year;
            document.getElementById('question-text').innerHTML = q.question;
            
            // Buttons state
            document.getElementById('btn-next').classList.toggle('hidden', currentQuestionIndex === currentQuizData.length - 1);
            document.getElementById('btn-submit').classList.toggle('hidden', currentQuestionIndex !== currentQuizData.length - 1);

            // Render Options
            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = '';
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                const isSelected = userAnswers[currentQuestionIndex] === idx;
                
                btn.className = `option-btn w-full text-left p-4 rounded-xl text-sm font-medium bg-slate-50 border border-slate-200 hover:bg-white hover:shadow-md ${isSelected ? 'option-selected' : ''}`;
                btn.innerHTML = `<span class="font-bold mr-2">${String.fromCharCode(65+idx)}.</span> ${opt}`;
                btn.onclick = () => selectOption(idx);
                optsContainer.appendChild(btn);
            });

            if (window.MathJax) MathJax.typesetPromise();
        }

        function selectOption(idx) {
            userAnswers[currentQuestionIndex] = idx;
            renderQuestion(); // Re-render to show selection state
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuizData.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        }

        function submitQuiz() {
            document.getElementById('quiz-active').classList.remove('flex');
            document.getElementById('quiz-active').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('quiz-results').classList.add('flex');

            let score = 0;
            const resultsList = document.getElementById('results-list');
            resultsList.innerHTML = '';

            currentQuizData.forEach((q, idx) => {
                const userIdx = userAnswers[idx];
                const isCorrect = userIdx === q.correctIndex;
                if (isCorrect) score++;

                const resultItem = document.createElement('div');
                resultItem.className = "bg-white p-6 rounded-2xl shadow-sm border border-slate-200";
                resultItem.innerHTML = `
                    <div class="flex justify-between mb-4">
                        <span class="text-xs font-bold text-slate-400">Q${idx + 1} • ${q.year}</span>
                        <span class="${isCorrect ? 'text-emerald-600' : 'text-red-500'} font-bold text-sm">
                            ${isCorrect ? 'Correct +4' : userIdx === undefined ? 'Unattempted 0' : 'Incorrect -1'}
                        </span>
                    </div>
                    <p class="text-slate-800 font-medium mb-4">${q.question}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
                        ${q.options.map((opt, oIdx) => {
                            let styles = "p-3 rounded-lg text-sm border ";
                            if (oIdx === q.correctIndex) styles += "option-correct";
                            else if (oIdx === userIdx && !isCorrect) styles += "option-wrong";
                            else styles += "bg-slate-50 border-slate-100 text-slate-500";
                            return `<div class="${styles}">${String.fromCharCode(65+oIdx)}. ${opt}</div>`;
                        }).join('')}
                    </div>

                    <div class="bg-emerald-50 p-4 rounded-xl text-xs md:text-sm text-emerald-900">
                        <strong class="block mb-1 text-emerald-700">Explanation:</strong>
                        ${q.explanation}
                    </div>
                `;
                resultsList.appendChild(resultItem);
            });

            document.getElementById('score-circle').innerText = `${score}/${currentQuizData.length}`;
            if (window.MathJax) MathJax.typesetPromise();
        }

        function quitQuiz() {
            if(confirm("Are you sure you want to quit the exam? Progress will be lost.")) {
                switchView('library');
            }
        }

        function closeQuiz() {
            switchView('library');
        }

        async function generateRoadmap() {
            switchView('chat');
            appendMsg('user', "Generate a 30-day Foundation Roadmap");
            await callAI("Create a bulleted 30-day study roadmap for Class 11 focusing on Physics (Mechanics), Chemistry (Atomic Structure), and Math (Trigonometry).");
        }

        function clearChat() {
            document.getElementById('chat-messages').innerHTML = '';
            appendMsg('ai', "MyndraAI memory reset. How can I assist you now?");
        }

        window.onload = () => {
            renderChapters();
        };
    </script>
</body>
</html>
